<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descarga Digital - Dashboard</title>
    
    <!-- Carrega a fonte Inter --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Carrega o Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carrega a Chart.js para gr√°ficos --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- NOVO: Carrega o plugin de datalabels para a Chart.js --><script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- Configura√ß√£o do Tailwind (Paleta ENAPOR e Fonte) --><script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'enapor-blue': '#003A70',
                        'enapor-orange': '#BE1D2C',
                        'enapor-green': '#BCBED0',
                        'enapor-gray': '#F8F9FA',
                        'enapor-red': '#D9534F', // Cor de erro
                        'chart-green': '#22C55E', // Verde para gr√°ficos (Descarregado)
                        'chart-orange': '#F97316' // Laranja para gr√°ficos (Pendente)
                    },
                    borderRadius: {
                        '2xl': '1rem', // 16px
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Estilos adicionais para um visual mais limpo */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Cor da barra de scroll */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Classe para a linha descarregada */
        .linha-descarregada {
            background-color: #D1F0E9; /* Tom de verde (MAIS FORTE) */
        }
        .linha-descarregada:hover {
            background-color: #B4E9DC; /* Tom de verde um pouco mais escuro no hover */
        }

        /* Classe para a linha pendente */
        .linha-pendente {
            background-color: #FFF7ED; /* Tom de laranja/amelo muito claro */
        }
        .linha-pendente:hover {
            background-color: #FEEDD6; /* Tom de laranja/amelo um pouco mais escuro no hover */
        }

        /* Estilos para o c√≠rculo de progresso */
        #login-progress-circle {
            /* Per√≠metro (Raio 46): 2 * PI * 46 = ~289 */
            stroke-dasharray: 289;
            stroke-dashoffset: 289;
            transition: stroke-dashoffset 1.5s ease-in-out;
        }

        #login-circle-spinner.is-loading #login-progress-circle {
            stroke-dashoffset: 0;
        }
        
        /* Garante que a sidebar mobile cobre o conte√∫do */
        @media (max-width: 767px) {
            #sidebar.hidden {
                transform: translateX(-100%);
            }
            #sidebar {
                transition: transform 0.3s ease-in-out;
            }
        }
        
        /* Estilos de Pagina√ß√£o */
        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .pagination-btn.active {
            background-color: #003A70; /* enapor-blue */
            color: white;
        }
        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn:not(.active):not(.disabled):hover {
            background-color: #e5e7eb; /* gray-200 */
        }


    </style>
</head>

<body class="bg-enapor-gray text-gray-800">

    <!-- Ecr√£ de Login Modernizado --><div id="login-screen" class="flex items-center justify-center min-h-screen bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1577561824128-53c3c78f1082?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNzEyNjZ8MHwxfGFsbHx8fHx8fHx8fDE3Mjk5NzEwNjl8&ixlib=rb-4.0.3&q=80&w=1920');">
        <!-- Overlay escuro --><div class="absolute inset-0 bg-enapor-blue/80 backdrop-blur-sm"></div>
        
        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-xl space-y-6 z-10">
            
            <!-- Contenedor do √çcone e Spinner --><div class="relative w-24 h-24 mx-auto">
                <!-- O √çcone (SVG) - Fica sempre vis√≠vel --><div class="absolute inset-0 flex items-center justify-center">
                    <!-- √çcone para 'Descarga Digital': Um contentor com uma seta para baixo --><svg class="w-12 h-12 text-enapor-blue" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <path d="M12 15v-6m-3 3 3 3 3-3"/> <!-- Seta para baixo --></svg>
                </div>
                
                <!-- C√≠rculo de Anima√ß√£o SVG --><svg id="login-circle-spinner" class="w-full h-full" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- C√≠rculo de fundo (o trilho) --><circle class="text-enapor-blue/20" stroke-width="4" stroke="currentColor" fill="transparent" r="46" cx="50" cy="50"/>
                    
                    <!-- C√≠rculo de progresso (a linha que preenche) --><circle id="login-progress-circle" 
                            class="text-enapor-blue" 
                            stroke-width="4" 
                            stroke-linecap="round" 
                            stroke="currentColor" 
                            fill="transparent" 
                            r="46" 
                            cx="50" 
                            cy="50"
                            transform="rotate(-90 50 50)"/> <!-- Roda -90 graus para come√ßar do topo --></svg>
            </div>
            
            <!-- T√çTULO --><div class="text-center">
                <h1 class="text-3xl font-bold text-enapor-blue">Descarga Digital</h1>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-user" class="block text-sm font-medium text-gray-700">Utilizador</label>
                    <input type="text" id="login-user" name="user" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" required>
                </div>
                <div>
                    <label for="login-pass" class="block text-sm font-medium text-gray-700">Palavra-passe</label>
                    <input type="password" id="login-pass" name="pass" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" required>
                </div>
                
                <!-- Mensagem de Erro de Login --><div id="login-error" class="text-enapor-red text-sm text-center hidden pt-2">
                    Utilizador ou palavra-passe incorretos.
                </div>
                
                <button type="submit" class="w-full px-4 py-3 text-sm font-semibold text-white bg-enapor-blue rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-enapor-blue focus:ring-offset-2 transition-all">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Aplica√ß√£o principal agora tem um ID e est√° oculta (hidden) --><div id="dashboard-app" class="flex h-screen hidden">
        <!-- Barra Lateral (Sidebar) - REDUZIDA --><aside id="sidebar" class="w-56 bg-enapor-blue text-white p-4 shadow-lg hidden md:flex flex-col flex-shrink-0 absolute md:relative z-20 h-full">
            <!-- Logo --><div class="mb-8 text-center"> <!-- Reduzido mb-10 para mb-8 --><img src="https://www.enapor.cv/web/image/843" alt="Logo ENAPOR" class="h-21 mx-auto"> </div>
            
            <!-- Navega√ß√£o Principal -->
            <!-- ATUALIZA√á√ÉO: Adicionadas classes border-l-4 para o apontamento de cor -->
            <nav class="flex-1 space-y-2">
                <a href="#" id="nav-navios" class="flex items-center gap-3 px-4 py-3 bg-white/10 text-white font-semibold rounded-lg border-l-4 border-enapor-orange">
                    <!-- √çcone üö¢ (Lucide: ShipWheel) --><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4"/><path d="M2 12h4"/><path d="m19.07 4.93-.88.88"/><path d="m5.81 18.19.88-.88"/><path d="M12 2v4"/><path d="M12 22v-4"/><path d="m4.93 4.93.88.88"/><path d="m18.19 18.19-.88-.88"/><circle cx="12" cy="12" r="8"/><circle cx="12" cy="12" r="2"/></svg>
                    <span>Navios</span>
                </a>
                <a href="#" id="nav-descarga" class="flex items-center gap-3 px-4 py-3 text-gray-200 hover:bg-white/10 hover:text-white font-medium rounded-lg border-l-4 border-transparent hover:border-enapor-orange/50">
                    <!-- √çcone  (Lucide: Box) --><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.29 7 12 12 20.71 7"></polyline><line x1="12" x2="12" y1="22" y2="12"></line></svg>
                    <span>Descarga</span>
                </a>
                <!-- NOVO: Link Indicadores --><a href="#" id="nav-indicadores" class="flex items-center gap-3 px-4 py-3 text-gray-200 hover:bg-white/10 hover:text-white font-medium rounded-lg border-l-4 border-transparent hover:border-enapor-orange/50">
                    <!-- √çcone (Lucide: BarChart3) --><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M7 12v5"></path><path d="M12 8v9"></path><path d="M17 14v3"></path></svg>
                    <span>Indicadores</span>
                </a>
            </nav>
            
            <!-- Logout --><div class="mt-auto">
                <a href="#" id="logout-btn" class="flex items-center gap-3 px-4 py-3 text-gray-200 hover:bg-white/10 hover:text-white font-medium rounded-lg border-l-4 border-transparent hover:border-enapor-orange">
                    <!-- √çcone üîí (Lucide: LogOut) --><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>
                    <span>Terminar sess√£o</span>
                </a>
            </div>
        </aside>

        <!-- Conte√∫do Principal --><div class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Header (Cabe√ßalho) - REDUZIDO --><header class="bg-white h-16 flex-shrink-0 shadow-sm flex items-center justify-between px-4 md:px-6">
                <!-- Lado Esquerdo: Bot√£o Mobile e T√≠tulo --><div class="flex items-center gap-3">
                    <!-- Bot√£o Menu Mobile --><button id="mobile-menu-btn" aria-label="Abrir menu" class="md:hidden text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line></svg>
                    </button>
                    
                    <!-- T√≠tulo (Azul) - Tamanho responsivo REDUZIDO --><h1 class="text-xl md:text-2xl font-bold text-enapor-blue">Descarga Digital</h1>
                </div>

                <!-- Lado Direito: Perfil do Utilizador (Avatar vis√≠vel no mobile) - REDUZIDO --><div class="flex items-center gap-3">
                    <img class="w-8 h-8 md:w-9 md:h-9 rounded-full object-cover" src="https://placehold.co/100x100/003A70/FFFFFF?text=JS" alt="Avatar Jo√£o Silva">
                    <div class="text-sm hidden md:block"> <!-- Texto escondido no mobile -->
                        <p class="font-semibold text-gray-900">Jo√£o Silva</p>
                        <p class="text-gray-500">Operador</p>
                    </div>
                </div>
            </header>

            <!-- 
                OTIMIZA√á√ÉO: 
                - Padding REDUZIDO de 'p-6 md:p-8' para 'p-4 md:p-6'
            --><main class="flex-1 flex flex-col p-4 md:p-6 overflow-hidden">

                <!-- 
                    OTIMIZA√á√ÉO: 
                    - 'space-y-6' REDUZIDO para 'space-y-4'
                --><div id="navios-section" class="flex-1 flex flex-col space-y-4 overflow-hidden">
                    <!-- NOVO: T√≠tulo e Barra de Pesquisa --><div class="space-y-4">
                        <!-- O T√≠tulo h1 foi movido para o <header> global -->
                        <div class="max-w-xl relative">
                            <label for="ship-search-input" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                <!-- √çcone de Pesquisa (Lucide: Search) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>
                            </label>
                            <!-- Pesquisa de Navios - REDUZIDA --><input type="text" id="ship-search-input" placeholder="Procurar por navio ou escala..." class="w-full pl-10 pr-4 py-1.5 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-enapor-blue">
                        </div>
                    </div>
                        
                    <!-- KPIs da sec√ß√£o de Navios - REDUZIDOS --><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-enapor-blue text-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm text-white font-semibold">Navios em Porto</p>
                            <p id="kpi-navios-porto" class="text-2xl font-bold text-white mt-1">0</p>
                        </div>
                        <div class="bg-enapor-green text-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm text-white font-semibold">Navios Descarregados</p>
                            <p id="kpi-navios-descarregados" class="text-2xl font-bold text-white mt-1">0</p>
                        </div>
                        <div class="bg-enapor-orange text-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm text-white font-semibold">Navios em Descarga</p>
                            <p id="kpi-navios-descarga" class="text-2xl font-bold text-white mt-1">0</p>
                        </div>
                    </div>

                    <!-- 
                        OTIMIZA√á√ÉO: 
                        - Container da tabela
                    --><div id="ship-table-container" class="bg-white rounded-2xl shadow-lg flex-1 flex flex-col overflow-hidden">
                        <!-- Cabe√ßalho da Tabela - REDUZIDO --><div class="px-5 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">Navios em Porto</h2>
                        </div>
                        
                        <!-- 
                            OTIMIZA√á√ÉO: 
                            - Wrapper de scroll
                        --><div class="overflow-x-auto overflow-y-auto flex-1">
                            <table class="w-full min-w-[600px] text-sm">
                                <thead>
                                    <tr class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <!-- Padding da Tabela REDUZIDO -->
                                        <th class="px-5 py-3">Navio</th>
                                        <th class="px-5 py-3">Porto Anterior</th>
                                        <th class="px-5 py-3">N¬∫ da Escala</th>
                                        <th class="px-5 py-3">Atraca√ß√£o</th>
                                        <th class="px-5 py-3">N¬∫ Contentores</th>
                                        <th class="px-5 py-3 text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="ship-table-body" class="">
                                    <!-- Conte√∫do gerado por JS --></tbody>
                            </table>
                        </div>
                        
                        <!-- Controlo de Pagina√ß√£o Navios - REDUZIDO --><div id="ship-pagination" class="px-5 py-3 border-t border-gray-200 flex justify-center items-center gap-2 text-sm">
                            <!-- Gerado por JS -->
                        </div>
                    </div>
                </div>
                
                <!-- 
                    OTIMIZA√á√ÉO: 
                    - 'space-y-6' REDUZIDO para 'space-y-4'
                --><div id="descarga-section" class="hidden flex-1 flex flex-col space-y-4 overflow-hidden">
                    <!-- NOVO: T√≠tulo e Barra de Pesquisa --><div class="space-y-4">
                        <!-- O T√≠tulo h1 foi movido para o <header> global -->
                        <div class="max-w-xl relative">
                            <label for="main-search-input" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                <!-- √çcone de Pesquisa (Lucide: Search) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>
                            </label>
                            <!-- Pesquisa de Contentores - REDUZIDA --><input type="text" id="main-search-input" placeholder="Procurar por contentor..." class="w-full pl-10 pr-4 py-1.5 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-enapor-blue">
                        </div>
                    </div>

                    <!-- Cabe√ßalho de informa√ß√µes do navio - REDUZIDO --><div id="descarga-header" class="hidden bg-white p-4 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">
                            Navio: <span id="descarga-navio-nome" class="text-enapor-blue"></span>
                        </h3>
                        <div class="flex flex-col md:flex-row md:gap-6 text-sm">
                            <p><strong>Escala:</strong> <span id="descarga-navio-escala" class="text-gray-700"></span></p>
                            <p><strong>Atraca√ß√£o:</strong> <span id="descarga-navio-atracacao" class="text-gray-700"></span></p>
                            <p><strong>Total Contentores:</strong> <span id="descarga-navio-total-contentores" class="text-gray-700"></span></p>
                        </div>
                    </div>
                    
                    <!-- Cart√µes KPI (Key Performance Indicators) - REDUZIDOS --><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-enapor-blue text-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm text-white font-semibold">Total Contentores</p>
                            <p id="kpi-contentores-total" class="text-2xl font-bold text-white mt-1">0</p>
                        </div>
                        <div class="bg-enapor-green text-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm text-white font-semibold">Contentores Descarregados</p>
                            <p id="kpi-contentores-descarregados" class="text-2xl font-bold text-white mt-1">0</p>
                        </div>
                        <div class="bg-enapor-orange text-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm text-white font-semibold">Contentores por Descarregar</p>
                            <p id="kpi-contentores-pendentes" class="text-2xl font-bold text-white mt-1">0</p>
                        </div>
                    </div>

                    <!-- 
                        OTIMIZA√á√ÉO: 
                        - Container da tabela
                    --><div class="bg-white rounded-2xl shadow-lg flex-1 flex flex-col overflow-hidden">
                        <!-- Cabe√ßalho da Tabela e Filtros - REDUZIDO --><div class="px-5 py-4 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                            <h2 class="text-lg font-semibold text-gray-900">Descargas em curso</h2>
                            <!-- Filtros e Bot√£o de Registo Manual --><div class="flex flex-wrap items-center justify-start md:justify-end gap-2">
                                <div id="discharge-filters" class="flex items-center gap-2" role="group" aria-label="Filtros de descarga">
                                    <button data-filter="todos" class="px-3 py-1 text-sm rounded-lg font-semibold text-gray-900 bg-gray-200" aria-pressed="true">Todos</button>
                                    <button data-filter="descarregado" class="px-3 py-1 text-sm rounded-lg font-medium text-gray-500 hover:bg-gray-100" aria-pressed="false">Descarregados</button>
                                    <button data-filter="pendente" class="px-3 py-1 text-sm rounded-lg font-medium text-gray-500 hover:bg-gray-100" aria-pressed="false">Pendentes</button>
                                </div>
                                <button id="open-manual-modal-btn" class="flex items-center gap-2 bg-enapor-orange text-white text-sm font-semibold px-3 py-1.5 rounded-lg shadow-md hover:bg-orange-600 transition-all">
                                    <!-- √çcone (Lucide: Plus) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>
                                    <span>Carga Mais</span>
                                </button>
                                <button id="finish-operation-btn" class="hidden flex items-center gap-2 bg-green-600 text-white text-sm font-semibold px-3 py-1.5 rounded-lg shadow-md hover:bg-green-700 transition-all">
                                    <!-- √çcone (Lucide: Check) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    <span>Finalizar Opera√ß√£o</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 
                            OTIMIZA√á√ÉO: 
                            - Wrapper de scroll
                        --><div class="overflow-x-auto overflow-y-auto flex-1">
                            <table class="w-full min-w-[500px] text-sm">
                                <thead>
                                    <tr class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <!-- Padding da Tabela REDUZIDO -->
                                        <th class="px-5 py-3">Navio</th>
                                        <th class="px-5 py-3">N¬∫ da Escala</th>
                                        <th class="px-5 py-3">Contentor</th>
                                        <th class="px-5 py-3">Tipo</th>
                                        <th class="px-5 py-3">Data de descarga</th>
                                        <th class="px-5 py-3 text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="discharge-table-body" class="">
                                    <!-- Conte√∫do gerado por JS --></tbody>
                            </table>
                        </div>
                        
                        <!-- Controlo de Pagina√ß√£o Descarga - REDUZIDO --><div id="discharge-pagination" class="px-5 py-3 border-t border-gray-200 flex justify-center items-center gap-2 text-sm">
                            <!-- Gerado por JS -->
                        </div>
                    </div>
                </div>

                <!-- NOVO: Sec√ß√£o de Indicadores com Gr√°ficos --><div id="indicadores-section" class="hidden flex-1 flex flex-col space-y-4 overflow-auto">
                    <h2 class="text-lg font-semibold text-gray-900">Indicadores de Performance</h2>
                    
                    <!-- KPIs num√©ricos (3 cart√µes) --><div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm font-medium text-gray-600">Contentores Registados (Carga Mais)</p>
                            <p id="indicador-contentores-a-mais" class="text-2xl font-bold text-enapor-blue mt-1">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm font-medium text-gray-600">Tempo M√©dio de Opera√ß√£o por Navio</p>
                            <p id="indicador-tempo-medio-navio" class="text-2xl font-bold text-enapor-blue mt-1">0h 00m</p>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-lg">
                            <p class="text-sm font-medium text-gray-600">Percentagem de Descarga Conclu√≠da (Global)</p>
                            <p id="indicador-percentagem-concluida" class="text-2xl font-bold text-enapor-blue mt-1">0%</p>
                        </div>
                    </div>

                    <!-- Gr√°ficos (Linha e Donut) --><div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-2xl shadow-lg flex flex-col">
                            <h3 class="text-md font-semibold text-gray-900 mb-2">Descargas por M√™s (√öltimos 6 Meses)</h3>
                            <div class="relative flex-1 h-64">
                                <canvas id="chart-descargas-mes"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-lg flex flex-col">
                            <h3 class="text-md font-semibold text-gray-900 mb-2">Estado da Descarga (Global)</h3>
                            <div class="relative flex-1 h-64">
                                <canvas id="chart-percentagem-concluida"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°fico (Barras) --><div class="grid grid-cols-1 gap-4 flex-1">
                        <div class="bg-white p-4 rounded-2xl shadow-lg flex flex-col">
                            <h3 class="text-md font-semibold text-gray-900 mb-2">Tempo de Opera√ß√£o por Navio Finalizado (minutos)</h3>
                            <div class="relative flex-1 h-64">
                                <canvas id="chart-tempos-navio"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Registo Manual - REDUZIDO --><div id="manual-register-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all opacity-0 scale-95">
            <!-- Cabe√ßalho do Modal --><div class="px-6 py-4 border-b border-gray-200">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Registar Carga Mais</h3>
            </div>
            
            <!-- Corpo do Modal com Formul√°rio --><form id="manual-register-form" class="p-6 space-y-3">
                <div>
                    <label for="manual-ship-select" class="block text-sm font-medium text-gray-700 mb-1">Navio</label>
                    <select id="manual-ship-select" name="ship" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" required>
                        <option value="">Selecione um navio...</option>
                        <!-- Op√ß√µes preenchidas por JS --></select>
                </div>
                <div>
                    <label for="manual-container-input" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Contentor</label>
                    <input type="text" id="manual-container-input" name="container" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" placeholder="Ex: MSCU1234567" required>
                </div>
                 <div>
                    <label for="manual-container-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</o>
                    <select id="manual-container-type" name="type" class="w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" required>
                        <option value="20P">20P</option>
                        <option value="40P">40P</option>
                        <option value="10P">10P</option>
                    </select>
                </div>
                <!-- Mensagem de erro (substitui o alert) --><div id="manual-register-error" class="text-enapor-red text-sm hidden"></div>
            </form>
            
            <!-- Rodap√© do Modal com A√ß√µes --><div class="px-6 py-3 bg-gray-50 rounded-b-2xl flex justify-end gap-2">
                <button id="cancel-manual-modal-btn" type="button" class="px-4 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancelar
                </button>
                <button id="save-manual-modal-btn" type="submit" form="manual-register-form" class="px-4 py-1.5 text-sm font-medium text-white bg-enapor-blue rounded-lg hover:bg-opacity-90">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification - REDUZIDO E CORRIGIDO --><div id="toast-notification" class="fixed top-5 right-5 bg-green-600 text-white px-5 py-2 rounded-lg shadow-lg transform translate-x-full opacity-0 transition-all duration-300 ease-in-out z-50">
        <p id="toast-message">Mensagem de sucesso!</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Base de Dados (Simulada) ---
            let db = {
                ships: [
                    {
                        name: "MAR D¬¥CANAL",
                        port: "NLRTM, NL",
                        flag: "nl",
                        escala: "GRA2025002630",
                        ata: "2025-11-01T10:00:00",
                        status: "finished" // MUDADO PARA FINISHED
                    },
                    {
                        name: "B.L√âZA",
                        port: "ESALG, ES",
                        flag: "es",
                        escala: "GRA2025002633",
                        ata: "2025-11-01T16:30:00",
                        status: "finished" // MUDADO PARA FINISHED
                    },
                    {
                        name: "CHIQUINHO BL",
                        port: "DEHAM, DE",
                        flag: "de",
                        escala: "GRA2025002640",
                        ata: "2025-11-02T09:00:00",
                        status: "finished" // MUDADO PARA FINISHED
                    },
                    {
                        name: "DONA TUTUTA",
                        port: "PTLXS, PT",
                        flag: "pt",
                        escala: "GRA2025002642",
                        ata: "2025-11-02T11:00:00",
                        status: "pending"
                    },
                    {
                        name: "PONTA DO SOL",
                        port: "FRMRS, FR",
                        flag: "fr",
                        escala: "GRA2025002650",
                        ata: "2025-11-02T14:00:00",
                        status: "pending"
                    },
                    {
                        name: "PRAIA D¬¥AGUADA",
                        port: "USNYC, US",
                        flag: "us",
                        escala: "GRA2025002651",
                        ata: "2025-11-02T18:00:00",
                        status: "pending"
                    },
                    {
                        name: "MONTE CARA",
                        port: "ITGOA, IT",
                        flag: "it",
                        escala: "GRA2025002655",
                        ata: "2025-11-03T08:00:00",
                        status: "pending"
                    },
                    {
                        name: "RIB. GRANDE",
                        port: "ESSVN, ES",
                        flag: "es",
                        escala: "GRA2025002656",
                        ata: "2025-11-03T10:30:00",
                        status: "pending"
                    },
                    {
                        name: "SANTO ANTAO",
                        port: "NLRTM, NL",
                        flag: "nl",
                        escala: "GRA2025002660",
                        ata: "2025-11-03T11:00:00",
                        status: "pending"
                    },
                    {
                        name: "MAR DE CANAL II",
                        port: "DEHAM, DE",
                        flag: "de",
                        escala: "GRA2025002661",
                        ata: "2025-11-03T12:45:00",
                        status: "pending"
                    },
                    // NOVOS NAVIOS ADICIONADOS
                    {
                        name: "PORTO NOVO",
                        port: "ESVLC, ES",
                        flag: "es",
                        escala: "GRA2025002665",
                        ata: "2025-11-04T09:15:00",
                        status: "pending"
                    },
                    {
                        name: "ILHA DO FOGO",
                        port: "MAPTM, MA",
                        flag: "ma",
                        escala: "GRA2025002668",
                        ata: "2025-11-04T14:00:00",
                        status: "pending"
                    },
                    {
                        name: "TARRAFAL",
                        port: "PTLEI, PT",
                        flag: "pt",
                        escala: "GRA2025002670",
                        ata: "2025-11-04T18:30:00",
                        status: "pending"
                    }
                ],
                discharges: [
                    // --- DADOS NOVEMBRO (M√äS ATUAL) ---
                    // MAR D¬¥CANAL (Finalizado)
                    { id: 1, shipName: "MAR D¬¥CANAL", escala: "GRA2025002630", container: "MSCU1234567", type: "20P", status: "descarregado", dischargeTime: "2025-11-01T10:45:12", cargaMais: false },
                    { id: 3, shipName: "MAR D¬¥CANAL", escala: "GRA2025002630", container: "MSCU1234568", type: "20P", status: "descarregado", dischargeTime: "2025-11-01T10:50:02", cargaMais: false },
                    { id: 7, shipName: "MAR D¬¥CANAL", escala: "GRA2025002630", container: "TRLU6543210", type: "40P", status: "descarregado", dischargeTime: "2025-11-01T11:05:00", cargaMais: false },
                    
                    // B.L√âZA (Finalizado)
                    { id: 2, shipName: "B.L√âZA", escala: "GRA2025002633", container: "CMAU7654321", type: "40P", status: "descarregado", dischargeTime: "2025-11-01T16:45:00", cargaMais: false },
                    { id: 8, shipName: "B.L√âZA", escala: "GRA2025002633", container: "CMAU7654322", type: "40P", status: "descarregado", dischargeTime: "2025-11-01T16:50:00", cargaMais: false },
                    { id: 9, shipName: "B.L√âZA", escala: "GRA2025002633", container: "HLCU1112223", type: "20P", status: "descarregado", dischargeTime: "2025-11-01T17:00:00", cargaMais: false },
                    { id: 25, shipName: "B.L√âZA", escala: "GRA2025002633", container: "HLCU1112224", type: "20P", status: "descarregado", dischargeTime: "2025-11-01T17:05:15", cargaMais: true }, // Carga Mais
                    
                    // CHIQUINHO BL (Finalizado)
                    { id: 4, shipName: "CHIQUINHO BL", escala: "GRA2025002640", container: "MRSU8765432", type: "40P", status: "descarregado", dischargeTime: "2025-11-02T09:10:00", cargaMais: false },
                    { id: 5, shipName: "CHIQUINHO BL", escala: "GRA2025002640", container: "MAEU5432109", type: "20P", status: "descarregado", dischargeTime: "2025-11-02T09:15:45", cargaMais: false },
                    { id: 10, shipName: "CHIQUINHO BL", escala: "GRA2025002640", container: "MRSU8765433", type: "40P", status: "descarregado", dischargeTime: "2025-11-02T09:20:00", cargaMais: false },
                    { id: 11, shipName: "CHIQUINHO BL", escala: "GRA2025002640", container: "MRSU8765434", type: "40P", status: "descarregado", dischargeTime: "2025-11-02T09:25:00", cargaMais: false },
                    
                    // DONA TUTUTA (Pendente)
                    { id: 6, shipName: "DONA TUTUTA", escala: "GRA2025002642", container: "EASU4567890", type: "40P", status: "pendente", dischargeTime: null, cargaMais: false },
                    { id: 12, shipName: "DONA TUTUTA", escala: "GRA2025002642", container: "EASU4567891", type: "20P", status: "descarregado", dischargeTime: "2025-11-02T11:30:00", cargaMais: false },
                    { id: 13, shipName: "DONA TUTUTA", escala: "GRA2025002642", container: "EASU4567892", type: "40P", status: "pendente", dischargeTime: null, cargaMais: false },
                    
                    // PONTA DO SOL (Pendente)
                    { id: 14, shipName: "PONTA DO SOL", escala: "GRA2025002650", container: "FCIU9876543", type: "20P", status: "pendente", dischargeTime: null, cargaMais: false },
                    
                    // PRAIA D¬¥AGUADA (Pendente)
                    { id: 15, shipName: "PRAIA D¬¥AGUADA", escala: "GRA2025002651", container: "OOLU1231234", type: "40P", status: "pendente", dischargeTime: null, cargaMais: false },
                    { id: 16, shipName: "PRAIA D¬¥AGUADA", escala: "GRA2025002651", container: "OOLU1231235", type: "20P", status: "pendente", dischargeTime: null, cargaMais: false },
                    
                    // MONTE CARA (Pendente)
                    { id: 17, shipName: "MONTE CARA", escala: "GRA2025002655", container: "TCNU5554443", type: "20P", status: "descarregado", dischargeTime: "2025-11-03T08:30:10", cargaMais: false },
                    { id: 18, shipName: "MONTE CARA", escala: "GRA2025002655", container: "TCNU5554444", type: "40P", status: "pendente", dischargeTime: null, cargaMais: false },
                    
                    // RIB. GRANDE (Pendente)
                    { id: 19, shipName: "RIB. GRANDE", escala: "GRA2025002656", container: "ZCSU7778889", type: "40P", status: "pendente", dischargeTime: null, cargaMais: false },
                    { id: 20, shipName: "RIB. GRANDE", escala: "GRA2025002656", container: "ZCSU7778880", type: "40P", status: "pendente", dischargeTime: null, cargaMais: false },
                    
                    // SANTO ANTAO (Pendente)
                    { id: 21, shipName: "SANTO ANTAO", escala: "GRA2025002660", container: "MSCU9998887", type: "20P", status: "pendente", dischargeTime: null, cargaMais: false },
                    { id: 22, shipName: "SANTO ANTAO", escala: "GRA2025002660", container: "MSCU9998886", type: "20P", status: "pendente", dischargeTime: null, cargaMais: false },
                    { id: 23, shipName: "SANTO ANTAO", escala: "GRA2025002660", container: "MSCU9998885", type: "40P", status: "pendente", dischargeTime: null, cargaMais: false },
                    
                    // MAR DE CANAL II (Pendente)
                    { id: 24, shipName: "MAR DE CANAL II", escala: "GRA2025002661", container: "TRLU8887776", type: "40P", status: "pendente", dischargeTime: null, cargaMais: false },

                    // --- DADOS FICT√çCIOS (MESES ANTERIORES) ---
                    // Outubro
                    { id: 101, shipName: "NAVIO OUTUBRO A", escala: "GRA2025002500", container: "TEST1", type: "20P", status: "descarregado", dischargeTime: "2025-10-05T10:00:00", cargaMais: false },
                    { id: 102, shipName: "NAVIO OUTUBRO A", escala: "GRA2025002500", container: "TEST2", type: "40P", status: "descarregado", dischargeTime: "2025-10-05T10:15:00", cargaMais: false },
                    { id: 103, shipName: "NAVIO OUTUBRO B", escala: "GRA2025002510", container: "TEST3", type: "20P", status: "descarregado", dischargeTime: "2025-10-15T14:30:00", cargaMais: false },
                    { id: 104, shipName: "NAVIO OUTUBRO B", escala: "GRA2025002510", container: "TEST4", type: "20P", status: "descarregado", dischargeTime: "2025-10-15T14:45:00", cargaMais: false },
                    { id: 105, shipName: "NAVIO OUTUBRO B", escala: "GRA2025002510", container: "TEST5", type: "40P", status: "descarregado", dischargeTime: "2025-10-15T15:00:00", cargaMais: true }, // Carga Mais
                    { id: 106, shipName: "NAVIO OUTUBRO C", escala: "GRA2025002520", container: "TEST6", type: "20P", status: "descarregado", dischargeTime: "2025-10-28T09:00:00", cargaMais: false },
                    
                    // Setembro
                    { id: 201, shipName: "NAVIO SETEMBRO A", escala: "GRA2025002400", container: "TEST10", type: "40P", status: "descarregado", dischargeTime: "2025-09-10T08:00:00", cargaMais: false },
                    { id: 202, shipName: "NAVIO SETEMBRO A", escala: "GRA2025002400", container: "TEST11", type: "40P", status: "descarregado", dischargeTime: "2025-09-10T08:30:00", cargaMais: false },
                    { id: 203, shipName: "NAVIO SETEMBRO B", escala: "GRA2025002410", container: "TEST12", type: "20P", status: "descarregado", dischargeTime: "2025-09-22T11:00:00", cargaMais: false },
                    
                    // Agosto
                    { id: 301, shipName: "NAVIO AGOSTO A", escala: "GRA2025002300", container: "TEST20", type: "20P", status: "descarregado", dischargeTime: "2025-08-01T10:00:00", cargaMais: false },
                    { id: 302, shipName: "NAVIO AGOSTO A", escala: "GRA2025002300", container: "TEST21", type: "40P", status: "descarregado", dischargeTime: "2025-08-01T10:20:00", cargaMais: false },
                    { id: 303, shipName: "NAVIO AGOSTO A", escala: "GRA2025002300", container: "TEST22", type: "20P", status: "descarregado", dischargeTime: "2025-08-01T10:40:00", cargaMais: false },
                    { id: 304, shipName: "NAVIO AGOSTO B", escala: "GRA2025002310", container: "TEST23", type: "40P", status: "descarregado", dischargeTime: "2025-08-19T16:00:00", cargaMais: false },

                    // Julho
                    { id: 401, shipName: "NAVIO JULHO A", escala: "GRA2025002200", container: "TEST30", type: "20P", status: "descarregado", dischargeTime: "2025-07-10T09:00:00", cargaMais: false },
                    { id: 402, shipName: "NAVIO JULHO A", escala: "GRA2025002200", container: "TEST31", type: "20P", status: "descarregado", dischargeTime: "2025-07-10T09:15:00", cargaMais: true }, // Carga Mais
                    
                    // Junho
                    { id: 501, shipName: "NAVIO JUNHO A", escala: "GRA2025002100", container: "TEST40", type: "40P", status: "descarregado", dischargeTime: "2025-06-20T14:00:00", cargaMais: false }
                ]
            };
            
            // --- Estado da Aplica√ß√£o ---
            let state = {
                currentView: 'login', // 'login', 'navios', 'descarga', 'indicadores'
                currentShipFilter: null, // null (todos) ou "Nome do Navio"
                currentStatusFilter: 'todos', // 'todos', 'pendente', 'descarregado'
                shipSearchTerm: '',
                dischargeSearchTerm: '',
                itemsPerPage: 10, // AUMENTADO de 7 para 10
                shipsCurrentPage: 1,
                dischargeCurrentPage: 1
            };

            // --- Inst√¢ncias dos Gr√°ficos ---
            let chartPercentagem = null;
            let chartTemposNavio = null;
            let chartDescargasMes = null; // NOVO: Gr√°fico de Linhas

            // --- Seletores de Elementos (DOM) ---
            // Login
            const loginScreen = document.getElementById('login-screen');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const loginPassInput = document.getElementById('login-pass');
            const loginCircleSpinner = document.getElementById('login-circle-spinner');
            const loginButton = loginForm.querySelector('button[type="submit"]');
            
            // App Principal
            const dashboardApp = document.getElementById('dashboard-app');
            const logoutBtn = document.getElementById('logout-btn');
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');

            // Navega√ß√£o
            const navNavios = document.getElementById('nav-navios');
            const navDescarga = document.getElementById('nav-descarga');
            const navIndicadores = document.getElementById('nav-indicadores');
            
            // Sec√ß√µes
            const naviosSection = document.getElementById('navios-section');
            const descargaSection = document.getElementById('descarga-section');
            const indicadoresSection = document.getElementById('indicadores-section');

            // Pesquisa
            const mainSearchInput = document.getElementById('main-search-input'); // Contentores
            const shipSearchInput = document.getElementById('ship-search-input'); // Navios

            // Tabelas
            const shipTableBody = document.getElementById('ship-table-body');
            const dischargeTableBody = document.getElementById('discharge-table-body');
            const shipPaginationContainer = document.getElementById('ship-pagination');
            const dischargePaginationContainer = document.getElementById('discharge-pagination');
            
            // Filtros Descarga
            const dischargeFilterButtons = document.querySelectorAll('#discharge-filters button');
            
            // Cabe√ßalho Descarga
            const descargaHeader = document.getElementById('descarga-header');
            const descargaNavioNome = document.getElementById('descarga-navio-nome');
            const descargaNavioEscala = document.getElementById('descarga-navio-escala');
            const descargaNavioAtracacao = document.getElementById('descarga-navio-atracacao');
            const descargaNavioTotalContentores = document.getElementById('descarga-navio-total-contentores');

            // Modal
            const manualModal = document.getElementById('manual-register-modal');
            const manualModalContent = manualModal.querySelector('.bg-white');
            const openModalBtn = document.getElementById('open-manual-modal-btn');
            const cancelModalBtn = document.getElementById('cancel-manual-modal-btn');
            const manualForm = document.getElementById('manual-register-form');
            const shipSelect = document.getElementById('manual-ship-select');
            const containerInput = document.getElementById('manual-container-input');
            const containerTypeSelect = document.getElementById('manual-container-type');
            const manualErrorDiv = document.getElementById('manual-register-error');
            const finishOperationBtn = document.getElementById('finish-operation-btn');

            // Toast
            const toastNotification = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            let toastTimer;

            // --- NOVO: Plugin Chart.js para Texto Central do Donut ---
            const donutCenterTextPlugin = {
                id: 'donutCenterText',
                beforeDraw: (chart) => {
                    // Verificar se √© um donut e se a op√ß√£o est√° ativa
                    if (chart.config.type !== 'doughnut' || !chart.config.options.plugins.donutCenterText) {
                        return;
                    }

                    const { ctx, data } = chart;
                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                    const text = total.toString();
                    const subText = 'Total';

                    ctx.save();
                    const x = chart.getDatasetMeta(0).data[0].x;
                    const y = chart.getDatasetMeta(0).data[0].y;

                    // Texto "Total" (mais pequeno, cinzento)
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = 'bold 16px Inter';
                    ctx.fillStyle = '#6b7280'; // gray-500
                    ctx.fillText(subText, x, y - 12);

                    // N√∫mero Total (maior, azul)
                    ctx.font = 'bold 24px Inter';
                    ctx.fillStyle = '#003A70'; // enapor-blue
                    ctx.fillText(text, x, y + 14);

                    ctx.restore();
                }
            };

            // --- Registar Plugins Globalmente ---
            // Registar o plugin de datalabels e o plugin de texto central
            Chart.register(ChartDataLabels, donutCenterTextPlugin);


            // --- Fun√ß√µes de Renderiza√ß√£o ---

            /**
             * Mostra uma notifica√ß√£o toast.
             * @param {string} message - A mensagem a exibir.
             * @param {boolean} [isSuccess=true] - true para sucesso (verde), false para erro (vermelho).
             */
            function showToast(message, isSuccess = true) {
                if (toastTimer) clearTimeout(toastTimer);

                toastMessage.textContent = message;
                toastNotification.classList.toggle('bg-green-600', isSuccess);
                toastNotification.classList.toggle('bg-enapor-red', !isSuccess);
                
                // MOSTRAR - remove opacidade 0 e translate-x-full
                toastNotification.classList.remove('translate-x-full', 'opacity-0');
                toastNotification.classList.add('translate-x-0', 'opacity-100');

                toastTimer = setTimeout(() => {
                    // ESCONDER - adiciona opacidade 0 e translate-x-full
                    toastNotification.classList.add('translate-x-full', 'opacity-0');
                    toastNotification.classList.remove('translate-x-0', 'opacity-100');
                }, 3000); // Esconde depois de 3 segundos
            }


            /**
             * Formata data ISO (ex: 2024-07-20T10:00:00) para DD/MM/AAAA HH:MM
             * @param {string | null} isoString
             * @returns {string}
             */
            function formatDateTime(isoString) {
                if (!isoString) return '--:--:--';
                try {
                    const date = new Date(isoString);
                    // pt-PT usa DD/MM/AAAA
                    const options = { 
                        dateStyle: 'short', 
                        timeStyle: 'medium', 
                        hour12: false 
                    };
                    return date.toLocaleString('pt-PT', options).replace(',', ''); // Remove v√≠rgula
                } catch (e) {
                    console.error('Data inv√°lida:', isoString);
                    return '--:--:--';
                }
            }
            
            /**
             * Formata data ISO (ex: 2024-07-20T10:00:00) para DD/MM/AAAA HH:MM (sem segundos)
             * @param {string} isoString
             * @returns {string}
             */
            function formatAtaDateTime(isoString) {
                 if (!isoString) return '--:--:--';
                try {
                    const date = new Date(isoString);
                    const options = { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false 
                    };
                    return date.toLocaleString('pt-PT', options).replace(',', '');
                } catch (e) {
                    console.error('Data inv√°lida:', isoString);
                    return '--:--:--';
                }
            }

            /**
             * Formata milissegundos num formato leg√≠vel (ex: 2h 15m)
             * @param {number} ms - Dura√ß√£o em milissegundos
             * @returns {string}
             */
            function formatDuration(ms) {
                if (isNaN(ms) || ms === 0) return '0h 00m';
                
                const totalMinutes = Math.floor(ms / (1000 * 60));
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                return `${hours}h ${minutes.toString().padStart(2, '0')}m`;
            }
            
            /**
             * Renderiza a pagina√ß√£o.
             * @param {HTMLElement} container - O elemento que cont√©m os bot√µes.
             * @param {number} totalItems - Total de itens (para calcular p√°ginas).
             * @param {number} currentPage - A p√°gina atual.
             * @param {function(number):void} pageChangeCallback - Fun√ß√£o chamada ao clicar num bot√£o de p√°gina.
             */
            function renderPagination(container, totalItems, currentPage, pageChangeCallback) {
                container.innerHTML = ''; // Limpar
                const totalPages = Math.ceil(totalItems / state.itemsPerPage);

                if (totalPages <= 1) {
                    return; // N√£o mostrar pagina√ß√£o se houver 1 ou 0 p√°ginas
                }

                // Bot√£o "Anterior"
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '&laquo; Anterior';
                prevBtn.className = 'pagination-btn';
                if (currentPage === 1) {
                    prevBtn.classList.add('disabled');
                } else {
                    prevBtn.addEventListener('click', () => pageChangeCallback(currentPage - 1));
                }
                container.appendChild(prevBtn);

                // Bot√µes de P√°gina (simplificado: mostra a p√°gina atual)
                const pageInfo = document.createElement('span');
                pageInfo.className = "px-2 text-gray-700";
                pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
                container.appendChild(pageInfo);


                // Bot√£o "Seguinte"
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = 'Seguinte &raquo;';
                nextBtn.className = 'pagination-btn';
                if (currentPage === totalPages) {
                    nextBtn.classList.add('disabled');
                } else {
                    nextBtn.addEventListener('click', () => pageChangeCallback(currentPage + 1));
                }
                container.appendChild(nextBtn);
            }


            /**
             * Renderiza a tabela de navios com base nos dados e filtros.
             */
            function renderShipTable() {
                // Ordenar navios por data de atraca√ß√£o (ata)
                const sortedShips = [...db.ships].sort((a, b) => new Date(a.ata) - new Date(b.ata));
                
                // Filtrar por termo de pesquisa
                const filteredShips = sortedShips.filter(ship => {
                    const searchTerm = state.shipSearchTerm.toLowerCase();
                    const nameMatch = ship.name.toLowerCase().includes(searchTerm);
                    const escalaMatch = ship.escala.toLowerCase().includes(searchTerm);
                    return nameMatch || escalaMatch;
                });
                
                // Paginar
                const startIndex = (state.shipsCurrentPage - 1) * state.itemsPerPage;
                const endIndex = startIndex + state.itemsPerPage;
                const paginatedShips = filteredShips.slice(startIndex, endIndex);

                // Limpar tabela
                shipTableBody.innerHTML = '';

                if (filteredShips.length === 0) {
                     shipTableBody.innerHTML = `<tr><td colspan="6" class="px-5 py-3 text-center text-gray-500">Nenhum navio encontrado.</td></tr>`;
                } else {
                    // Criar e adicionar linhas
                    paginatedShips.forEach(ship => {
                        const row = document.createElement('tr');
                        const isFinished = ship.status === 'finished';
                        row.className = `border-b border-gray-100 last:border-b-0 ${isFinished ? 'linha-descarregada' : 'hover:bg-gray-50'}`;
                        
                        const ataFormatted = formatAtaDateTime(ship.ata);
                        
                        // Calcular total de contentores para este navio
                        const totalContentores = db.discharges.filter(d => d.shipName === ship.name).length;

                        // Padding da Tabela REDUZIDO de 'px-6 py-4' para 'px-5 py-3'
                        row.innerHTML = `
                            <td class="px-5 py-3 whitespace-nowrap font-medium text-gray-900">${ship.name}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-gray-600 flex items-center gap-2">
                                ${ship.port} 
                                <img src="https://flagcdn.com/w20/${ship.flag}.png" alt="Bandeira ${ship.flag.toUpperCase()}" class="h-3">
                            </td>
                            <td class="px-5 py-3 whitespace-nowrap text-gray-600">${ship.escala}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-gray-600">${ataFormatted}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-gray-600">${totalContentores}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-right">
                                <button class="font-medium text-enapor-blue hover:underline view-containers-btn" data-ship-name="${ship.name}">
                                    Ver Contentores
                                </button>
                            </td>
                        `;
                        shipTableBody.appendChild(row);
                    });
                }
                
                // Renderizar Pagina√ß√£o
                renderPagination(shipPaginationContainer, filteredShips.length, state.shipsCurrentPage, (newPage) => {
                    state.shipsCurrentPage = newPage;
                    renderShipTable(); // Re-renderizar tabela com a nova p√°gina
                });
            }

            /**
             * Renderiza a tabela de descargas com base nos dados e filtros.
             */
            function renderDischargeTable() {
                // Filtrar descargas
                const filteredDischarges = db.discharges.filter(item => {
                    const shipMatch = !state.currentShipFilter || item.shipName === state.currentShipFilter;
                    const statusMatch = state.currentStatusFilter === 'todos' || item.status === state.currentStatusFilter;
                    const searchMatch = item.container.toLowerCase().includes(state.dischargeSearchTerm.toLowerCase());
                    return shipMatch && statusMatch && searchMatch;
                });
                
                // Paginar
                const startIndex = (state.dischargeCurrentPage - 1) * state.itemsPerPage;
                const endIndex = startIndex + state.itemsPerPage;
                const paginatedDischarges = filteredDischarges.slice(startIndex, endIndex);

                // Limpar tabela
                dischargeTableBody.innerHTML = '';

                if (filteredDischarges.length === 0) {
                     dischargeTableBody.innerHTML = `<tr><td colspan="6" class="px-5 py-3 text-center text-gray-500">Nenhum contentor encontrado.</td></tr>`;
                } else {
                    // Criar e adicionar linhas
                    paginatedDischarges.forEach(item => {
                        const row = document.createElement('tr');
                        const isPendente = item.status === 'pendente';
                        row.className = `border-b border-gray-100 last:border-b-0 ${isPendente ? 'linha-pendente' : 'linha-descarregada'}`;
                        
                        const timeFormatted = formatDateTime(item.dischargeTime);
                        
                        const actionButtonHtml = isPendente
                            ? `<button class="px-3 py-1 text-xs font-medium text-white bg-enapor-blue rounded-md hover:bg-opacity-90 action-btn" data-action="descarregar" data-id="${item.id}">Descarregar</button>`
                            : `<button class="px-3 py-1 text-xs font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 action-btn" data-action="desmarcar" data-id="${item.id}">Desmarcar</button>`;
                        
                        // Padding da Tabela REDUZIDO de 'px-6 py-4' para 'px-5 py-3'
                        row.innerHTML = `
                            <td class="px-5 py-3 whitespace-nowrap font-medium text-gray-900">${item.shipName}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-gray-600">${item.escala}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-gray-600">${item.container}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-gray-600">${item.type}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-gray-600">${timeFormatted}</td>
                            <td class="px-5 py-3 whitespace-nowrap text-right">
                                ${actionButtonHtml}
                            </td>
                        `;
                        dischargeTableBody.appendChild(row);
                    });
                }
                
                // Renderizar Pagina√ß√£o
                renderPagination(dischargePaginationContainer, filteredDischarges.length, state.dischargeCurrentPage, (newPage) => {
                    state.dischargeCurrentPage = newPage;
                    renderDischargeTable(); // Re-renderizar tabela com a nova p√°gina
                });
            }

            /**
             * Calcula e renderiza os KPIs num√©ricos dos indicadores.
             */
            function renderIndicadoresKPIs() {
                // 1. Contentores registados a mais
                const contentoresAMais = db.discharges.filter(d => d.cargaMais === true).length;
                document.getElementById('indicador-contentores-a-mais').textContent = contentoresAMais;

                // 2. Percentagem de descarga conclu√≠da (Global)
                const totalContentoresGlobal = db.discharges.length;
                const totalDescarregadosGlobal = db.discharges.filter(d => d.status === 'descarregado').length;
                const percentagemConcluida = (totalContentoresGlobal > 0) 
                    ? (totalDescarregadosGlobal / totalContentoresGlobal * 100) 
                    : 0;
                document.getElementById('indicador-percentagem-concluida').textContent = `${percentagemConcluida.toFixed(1)}%`;

                // 3. Tempo m√©dio por Navio
                const { average } = getShipOperationTimes();
                document.getElementById('indicador-tempo-medio-navio').textContent = formatDuration(average);
            }

             /**
             * Calcula os tempos de opera√ß√£o para navios finalizados.
             * @returns {{labels: string[], data: number[], average: number}}
             */
            function getShipOperationTimes() {
                let totalDuration = 0;
                let finishedShipsCount = 0;
                const labels = [];
                const data = []; // Dura√ß√£o em minutos

                const finishedShips = db.ships.filter(s => s.status === 'finished');

                finishedShips.forEach(ship => {
                    const shipDischarges = db.discharges
                        .filter(d => d.shipName === ship.name && d.status === 'descarregado' && d.dischargeTime)
                        .map(d => new Date(d.dischargeTime).getTime()); // Obter timestamps
                    
                    if (shipDischarges.length > 0) {
                        const firstDischarge = Math.min(...shipDischarges);
                        const lastDischarge = Math.max(...shipDischarges);
                        let durationMs = lastDischarge - firstDischarge;

                        // Se houver apenas 1 contentor, consideramos uma dura√ß√£o m√≠nima (ex: 5 min)
                        if (durationMs === 0 && shipDischarges.length > 0) {
                            durationMs = 300000; // 5 minutos em ms
                        }
                        
                        totalDuration += durationMs;
                        finishedShipsCount++;
                        labels.push(ship.name);
                        data.push(Math.floor(durationMs / 60000)); // Converter para minutos
                    }
                });

                const average = (finishedShipsCount === 0) ? 0 : (totalDuration / finishedShipsCount);
                return { labels, data, average };
            }

            /**
             * Destr√≥i gr√°ficos existentes (para evitar sobreposi√ß√£o).
             */
            function destroyGraficos() {
                if (chartPercentagem) {
                    chartPercentagem.destroy();
                    chartPercentagem = null;
                }
                if (chartTemposNavio) {
                    chartTemposNavio.destroy();
                    chartTemposNavio = null;
                }
                if (chartDescargasMes) {
                    chartDescargasMes.destroy();
                    chartDescargasMes = null;
                }
            }

            /**
             * Renderiza TODOS os gr√°ficos na sec√ß√£o de Indicadores.
             */
            function renderGraficos() {
                destroyGraficos(); // Limpar gr√°ficos anteriores
                
                renderGraficoLinhasMes();
                renderGraficoDonut();
                renderGraficoBarras();
            }

            /**
             * Renderiza o gr√°fico de Linhas (Descargas por M√™s).
             */
            function renderGraficoLinhasMes() {
                const meses = ['Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov']; // √öltimos 6 meses
                const data = [0, 0, 0, 0, 0, 0];
                const hoje = new Date(2025, 10, 5); // Simular data atual (Novembro 2025)
                const anoAtual = hoje.getFullYear();

                db.discharges.forEach(d => {
                    if (d.status === 'descarregado' && d.dischargeTime) {
                        const dataDescarga = new Date(d.dischargeTime);
                        if (dataDescarga.getFullYear() === anoAtual) {
                            const mes = dataDescarga.getMonth(); // 0 = Jan, 10 = Nov
                            
                            // Mapear m√™s para o √≠ndice do array 'meses' (0-5)
                            // 5 = Junho (√≠ndice 0)
                            // 10 = Novembro (√≠ndice 5)
                            const index = mes - 5; 
                            if (index >= 0 && index < data.length) {
                                data[index]++;
                            }
                        }
                    }
                });

                const ctx = document.getElementById('chart-descargas-mes').getContext('2d');
                chartDescargasMes = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: meses,
                        datasets: [{
                            label: 'Contentores Descarregados',
                            data: data,
                            borderColor: tailwind.config.theme.extend.colors['enapor-blue'],
                            backgroundColor: 'rgba(0, 58, 112, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            // --- NOVO: Configura√ß√£o Datalabels para Gr√°fico de Linha ---
                            datalabels: {
                                display: true,
                                align: 'top',
                                anchor: 'end',
                                backgroundColor: 'rgba(0, 58, 112, 0.8)', // enapor-blue
                                borderColor: 'white',
                                borderWidth: 2,
                                borderRadius: 4,
                                color: 'white',
                                font: {
                                    weight: 'bold'
                                },
                                padding: 4
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'N¬∫ Contentores' } }
                        }
                    }
                });
            }

            /**
             * Renderiza o gr√°fico Donut (Percentagem Conclu√≠da).
             */
            function renderGraficoDonut() {
                const totalContentoresGlobal = db.discharges.length;
                const totalDescarregadosGlobal = db.discharges.filter(d => d.status === 'descarregado').length;
                const totalPendentesGlobal = totalContentoresGlobal - totalDescarregadosGlobal;

                const ctx = document.getElementById('chart-percentagem-concluida').getContext('2d');
                chartPercentagem = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Descarregados', 'Pendentes'],
                        datasets: [{
                            data: [totalDescarregadosGlobal, totalPendentesGlobal],
                            backgroundColor: [
                                tailwind.config.theme.extend.colors['chart-green'], // Verde
                                tailwind.config.theme.extend.colors['chart-orange']  // Laranja
                            ],
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            // --- NOVO: Ativar plugin de texto central ---
                            donutCenterText: true,
                            // --- NOVO: Configura√ß√£o Datalabels para Gr√°fico Donut ---
                            datalabels: {
                                display: true,
                                color: 'white',
                                font: {
                                    weight: 'bold',
                                    size: 14
                                },
                                // Formatar para mostrar "Valor (Percentagem%)"
                                formatter: (value, ctx) => {
                                    const dataPoints = ctx.chart.data.datasets[0].data;
                                    const total = dataPoints.reduce((a, b) => a + b, 0);
                                    const percentage = (value / total) * 100;
                                    
                                    if (percentage < 5) return null; // Esconder se for muito pequeno

                                    return `${value} (${percentage.toFixed(1)}%)`;
                                }
                            }
                        }
                    }
                });
            }

            /**
             * Renderiza o gr√°fico de Barras (Tempos por Navio).
             */
            function renderGraficoBarras() {
                const { labels, data } = getShipOperationTimes();
                
                const ctx = document.getElementById('chart-tempos-navio').getContext('2d');
                chartTemposNavio = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels.length > 0 ? labels : ['Nenhum navio finalizado'],
                        datasets: [{
                            label: 'Tempo de Opera√ß√£o (minutos)',
                            data: data.length > 0 ? data : [0],
                            backgroundColor: tailwind.config.theme.extend.colors['enapor-blue'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Esconder legenda para um gr√°fico de barras simples
                            },
                            // --- NOVO: Configura√ß√£o Datalabels para Gr√°fico de Barras ---
                            datalabels: {
                                display: true,
                                anchor: 'end',
                                align: 'top',
                                color: '#333',
                                font: {
                                    weight: 'bold'
                                },
                                // Adicionar " min" ao valor
                                formatter: (value) => value > 0 ? `${value} min` : null
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Minutos'
                                },
                                // --- CORRE√á√ÉO: Adicionada v√≠rgula e 'max: 50' ---
                                max: 50
                            }
                        }
                    }
                });
            }


            // --- Fun√ß√µes de Atualiza√ß√£o de Estado e UI ---

            /**
             * Atualiza os KPIs da sec√ß√£o Navios.
             */
            function updateShipKPIs() {
                const totalShips = db.ships.length;
                const finishedShips = db.ships.filter(s => s.status === 'finished').length;
                
                document.getElementById('kpi-navios-porto').textContent = totalShips;
                document.getElementById('kpi-navios-descarregados').textContent = finishedShips; // KPI agora reflete navios finalizados
                document.getElementById('kpi-navios-descarga').textContent = totalShips; // "Navios em Descarga" = "Navios em Porto"
            }

            /**
             * Atualiza os KPIs da sec√ß√£o Descarga.
             */
            function updateDischargeKPIs() {
                // Filtra descargas com base APENAS no filtro de navio
                const relevantDischarges = db.discharges.filter(item => 
                    !state.currentShipFilter || item.shipName === state.currentShipFilter
                );

                const descarregadosCount = relevantDischarges.filter(item => item.status === 'descarregado').length;
                const pendentesCount = relevantDischarges.filter(item => item.status === 'pendente').length;
                
                document.getElementById('kpi-contentores-total').textContent = descarregadosCount + pendentesCount;
                document.getElementById('kpi-contentores-descarregados').textContent = descarregadosCount;
                document.getElementById('kpi-contentores-pendentes').textContent = pendentesCount;
            }

            /**
             * Mostra uma "view" (sec√ß√£o) principal e esconde as outras.
             * @param {string} viewName - O nome da view ('navios', 'descarga', 'indicadores').
             * @param {object | null} [shipInfo=null] - (Opcional) Objeto com {name, escala, atracacao}.
             */
            function showView(viewName, shipInfo = null) {
                state.currentView = viewName;
                state.currentShipFilter = shipInfo ? shipInfo.name : null;

                // Destruir gr√°ficos se sairmos da sec√ß√£o de indicadores
                if (viewName !== 'indicadores') {
                    destroyGraficos();
                }

                // Esconder todas as sec√ß√µes
                naviosSection.classList.add('hidden');
                descargaSection.classList.add('hidden');
                indicadoresSection.classList.add('hidden');
                descargaHeader.classList.add('hidden');
                finishOperationBtn.classList.add('hidden'); // Esconder bot√£o 'Finalizar' por defeito
                
                // Resetar estado ativo da navega√ß√£o
                [navNavios, navDescarga, navIndicadores].forEach(nav => {
                    nav.classList.remove('bg-white/10', 'text-white', 'font-semibold', 'border-enapor-orange');
                    nav.classList.add('text-gray-200', 'font-medium', 'hover:text-white', 'border-transparent');
                });

                if (viewName === 'navios') {
                    naviosSection.classList.remove('hidden');
                    state.dischargeSearchTerm = ''; // Limpa pesquisa de contentores
                    mainSearchInput.value = ''; 
                    state.shipsCurrentPage = 1; // Resetar p√°gina
                    
                    navNavios.classList.add('bg-white/10', 'text-white', 'font-semibold', 'border-enapor-orange');
                    navNavios.classList.remove('text-gray-200', 'font-medium', 'hover:text-white', 'border-transparent');
                    
                    renderShipTable();
                    updateShipKPIs();
                
                } else if (viewName === 'descarga') {
                    descargaSection.classList.remove('hidden');
                    state.shipSearchTerm = ''; // Limpa pesquisa de navios
                    shipSearchInput.value = ''; 
                    state.dischargeCurrentPage = 1; // Resetar p√°gina
                    
                    navDescarga.classList.add('bg-white/10', 'text-white', 'font-semibold', 'border-enapor-orange');
                    navDescarga.classList.remove('text-gray-200', 'font-medium', 'hover:text-white', 'border-transparent');
                    
                    // Se viemos de "Ver Contentores", preencher o cabe√ßalho
                    if (shipInfo) {
                        descargaNavioNome.textContent = shipInfo.name;
                        descargaNavioEscala.textContent = shipInfo.escala;
                        descargaNavioAtracacao.textContent = formatAtaDateTime(shipInfo.ata);
                        
                        // Calcular e preencher total de contentores
                        const totalContentores = db.discharges.filter(d => d.shipName === shipInfo.name).length;
                        descargaNavioTotalContentores.textContent = totalContentores;

                        descargaHeader.classList.remove('hidden');
                        
                        // Mostrar bot√£o 'Finalizar' apenas se o navio n√£o estiver finalizado
                        const ship = db.ships.find(s => s.name === shipInfo.name);
                        if (ship && ship.status !== 'finished') {
                            finishOperationBtn.classList.remove('hidden');
                        }
                        
                        // Ao ver um navio espec√≠fico, mostrar 'todos' por defeito
                        state.currentStatusFilter = 'todos';
                    } else {
                        // Ao clicar em "Descarga", mostrar 'pendente' por defeito
                        state.currentStatusFilter = 'pendente';
                    }
                    
                    updateDischargeFilterUI();
                    renderDischargeTable();
                    updateDischargeKPIs();
                
                } else if (viewName === 'indicadores') {
                    indicadoresSection.classList.remove('hidden');
                    
                    navIndicadores.classList.add('bg-white/10', 'text-white', 'font-semibold', 'border-enapor-orange');
                    navIndicadores.classList.remove('text-gray-200', 'font-medium', 'hover:text-white', 'border-transparent');

                    renderIndicadoresKPIs(); // Calcular e mostrar os KPIs
                    
                    // A Chart.js precisa de um pequeno delay para renderizar corretamente
                    // quando o contentor estava 'hidden'
                    setTimeout(() => {
                        renderGraficos(); // Calcular e mostrar os Gr√°ficos
                    }, 50); 
                }
                
                // Fecha a sidebar no mobile ao navegar
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex'); // Garante que no mobile 'hidden' tem preced√™ncia
            }
            
            /**
             * Atualiza o estado visual dos bot√µes de filtro de descarga.
             */
            function updateDischargeFilterUI() {
                dischargeFilterButtons.forEach(btn => {
                    const isPressed = btn.dataset.filter === state.currentStatusFilter;
                    btn.classList.toggle('font-semibold', isPressed);
                    btn.classList.toggle('text-gray-900', isPressed);
                    btn.classList.toggle('bg-gray-200', isPressed);
                    
                    btn.classList.toggle('font-medium', !isPressed);
                    btn.classList.toggle('text-gray-500', !isPressed);
                    btn.classList.toggle('hover:bg-gray-100', !isPressed);
                    
                    btn.setAttribute('aria-pressed', isPressed);
                });
            }

            // --- L√≥gica do Modal ---

            function openManualModal() {
                // Preencher select com navios da DB
                shipSelect.innerHTML = '<option value="">Selecione um navio...</option>';
                
                // Mostrar apenas navios pendentes no modal
                db.ships.filter(s => s.status === 'pending').forEach(ship => {
                    const option = document.createElement('option');
                    option.value = ship.name;
                    option.textContent = ship.name;
                    // Guardar dados extra no option para f√°cil acesso
                    option.dataset.escala = ship.escala;
                    shipSelect.appendChild(option);
                });
                
                manualErrorDiv.classList.add('hidden'); // Limpar erros
                manualErrorDiv.textContent = '';
                manualForm.reset();

                // Mostrar modal com anima√ß√£o
                manualModal.classList.remove('hidden');
                setTimeout(() => {
                    manualModalContent.classList.remove('opacity-0', 'scale-95');
                    manualModalContent.classList.add('opacity-100', 'scale-100');
                }, 10);
            }

            function closeManualModal() {
                manualModalContent.classList.remove('opacity-100', 'scale-100');
                manualModalContent.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    manualModal.classList.add('hidden');
                }, 300); // Dura√ß√£o da anima√ß√£o
            }

            function handleManualFormSubmit(e) {
                e.preventDefault();
                manualErrorDiv.classList.add('hidden');
                
                const selectedShipName = shipSelect.value;
                const container = containerInput.value.toUpperCase();
                const type = containerTypeSelect.value;

                // Valida√ß√£o
                if (!selectedShipName) {
                    manualErrorDiv.textContent = 'Por favor, selecione um navio.';
                    manualErrorDiv.classList.remove('hidden');
                    return;
                }
                
                if (!container) { 
                     manualErrorDiv.textContent = 'Por favor, insira um n√∫mero de contentor.';
                    manualErrorDiv.classList.remove('hidden');
                    return;
                }

                // Obter a escala do navio selecionado
                const selectedOption = shipSelect.querySelector(`option[value="${selectedShipName}"]`);
                const escala = selectedOption.dataset.escala;

                // Criar novo registo de descarga
                const newDischarge = {
                    id: Date.now(), // ID √∫nico
                    shipName: selectedShipName,
                    escala: escala,
                    container: container,
                    type: type,
                    status: "pendente", // "Carga Mais" entra como pendente
                    dischargeTime: null,
                    cargaMais: true // Marcar como "Carga Mais"
                };

                // Adicionar √† base de dados simulada
                db.discharges.push(newDischarge);

                // Re-renderizar UI
                renderDischargeTable();
                updateDischargeKPIs();

                closeManualModal();
            }

            // --- L√≥gica de A√ß√µes da Tabela ---

            function handleDischargeAction(e) {
                const button = e.target.closest('.action-btn');
                if (!button) return;

                const action = button.dataset.action;
                const id = parseInt(button.dataset.id, 10);

                // Encontrar o item na "base de dados"
                const item = db.discharges.find(d => d.id === id);
                if (!item) return;

                if (action === 'descarregar') {
                    item.status = 'descarregado';
                    item.dischargeTime = new Date().toISOString();
                    // Mostrar Toast de sucesso
                    showToast(`Contentor ${item.container} descarregado com sucesso`);
                } else if (action === 'desmarcar') {
                    item.status = 'pendente';
                    item.dischargeTime = null;
                }

                // Re-renderizar a tabela e KPIs
                renderDischargeTable();
                updateDischargeKPIs();
            }
            
            function handleViewContainers(e) {
                 const button = e.target.closest('.view-containers-btn');
                 if (!button) return;
                 
                 e.preventDefault();
                 const shipName = button.dataset.shipName;
                 const ship = db.ships.find(s => s.name === shipName);
                 
                 if (ship) {
                    const shipInfo = {
                        name: ship.name,
                        escala: ship.escala,
                        ata: ship.ata // Passa a data ISO
                    };
                    showView('descarga', shipInfo);
                 }
            }

            /**
             * Finaliza a opera√ß√£o para o navio atual.
             */
            function handleFinishOperation() {
                if (!state.currentShipFilter) return; 

                const shipName = state.currentShipFilter;
                const ship = db.ships.find(s => s.name === shipName);
                
                if (ship) {
                    ship.status = 'finished'; // Marcar como finalizado
                    
                    // 1. Mostrar toast
                    showToast('Opera√ß√£o Finalizada com sucesso');
                    
                    // 2. Voltar para a sec√ß√£o de navios (que agora mostrar√° a linha a verde)
                    showView('navios');
                    
                    // 3. Atualizar KPIs dos Navios
                    updateShipKPIs();
                }
            }


            // --- Event Listeners ---

            // Login / Logout
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const user = e.target.elements.user.value;
                const pass = e.target.elements.pass.value;

                loginError.classList.add('hidden');
                loginCircleSpinner.classList.add('is-loading');
                loginButton.disabled = true;
                loginButton.classList.add('opacity-50');

                setTimeout(() => {
                    loginCircleSpinner.classList.remove('is-loading');
                    loginButton.disabled = false;
                    loginButton.classList.remove('opacity-50');

                    if (user === 'admin' && pass === 'admin') {
                        loginScreen.classList.add('hidden');
                        dashboardApp.classList.remove('hidden');
                        loginPassInput.value = '';
                        showView('navios'); // Mostrar 'navios' ao fazer login
                    } else {
                        loginError.textContent = 'Utilizador ou palavra-passe incorretos.';
                        loginError.classList.remove('hidden');
                    }
                }, 1500);
            });

            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                dashboardApp.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                loginPassInput.value = '';
                state.currentView = 'login';
            });
            
            // Menu Mobile
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hidden'); // Alterna entre hidden e a classe de display (flex)
            });

            // Navega√ß√£o Principal
            navNavios.addEventListener('click', (e) => {
                e.preventDefault();
                showView('navios');
            });

            navDescarga.addEventListener('click', (e) => {
                e.preventDefault();
                showView('descarga'); // Mostra todos os contentores, filtrados por 'pendente'
            });

            navIndicadores.addEventListener('click', (e) => {
                e.preventDefault();
                showView('indicadores');
            });

            // Pesquisa
            shipSearchInput.addEventListener('input', (e) => {
                state.shipSearchTerm = e.target.value;
                state.shipsCurrentPage = 1; // Resetar p√°gina ao pesquisar
                renderShipTable();
            });
            
            mainSearchInput.addEventListener('input', (e) => {
                state.dischargeSearchTerm = e.target.value;
                state.dischargeCurrentPage = 1; // Resetar p√°gina ao pesquisar
                renderDischargeTable();
            });
            
            // Filtros de Descarga
            document.getElementById('discharge-filters').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-filter]');
                if (!button) return;
                
                state.currentStatusFilter = button.dataset.filter;
                state.dischargeCurrentPage = 1; // Resetar p√°gina ao filtrar
                updateDischargeFilterUI();
                renderDischargeTable();
            });

            // A√ß√µes nas Tabelas (Event Delegation)
            shipTableBody.addEventListener('click', handleViewContainers);
            dischargeTableBody.addEventListener('click', handleDischargeAction);

            // Modal
            openModalBtn.addEventListener('click', openManualModal);
            cancelModalBtn.addEventListener('click', closeManualModal);
            manualModal.addEventListener('click', (e) => {
                if (e.target === manualModal) { // Fechar se clicar no fundo
                    closeManualModal();
                }
            });
            manualForm.addEventListener('submit', handleManualFormSubmit);

            // Bot√£o Finalizar Opera√ß√£o
            finishOperationBtn.addEventListener('click', handleFinishOperation);

            // --- Estado Inicial ---
            // A app agora espera pelo login para mostrar a primeira view.
        });
    </script>
</body>
</html>
