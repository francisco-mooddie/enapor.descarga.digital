<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descarga Digital - Dashboard</title>
    
    <!-- Carrega a fonte Inter --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Carrega o Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configura√ß√£o do Tailwind (Paleta ENAPOR e Fonte) --><script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'enapor-blue': '#003A70',
                        'enapor-orange': '#BE1D2C',
                        'enapor-green': '#BCBED0',
                        'enapor-gray': '#F8F9FA',
                        'enapor-red': '#D9534F' // Cor de erro
                    },
                    borderRadius: {
                        '2xl': '1rem', // 16px
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Estilos adicionais para um visual mais limpo */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Cor da barra de scroll */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Classe para a linha descarregada */
        .linha-descarregada {
            background-color: #D1F0E9; /* Tom de verde (MAIS FORTE) */
        }
        .linha-descarregada:hover {
            background-color: #B4E9DC; /* Tom de verde um pouco mais escuro no hover */
        }

        /* Classe para a linha pendente */
        .linha-pendente {
            background-color: #FFF7ED; /* Tom de laranja/amelo muito claro */
        }
        .linha-pendente:hover {
            background-color: #FEEDD6; /* Tom de laranja/amelo um pouco mais escuro no hover */
        }

        /* Estilos para o c√≠rculo de progresso */
        #login-progress-circle {
            /* Per√≠metro (Raio 46): 2 * PI * 46 = ~289 */
            stroke-dasharray: 289;
            stroke-dashoffset: 289;
            transition: stroke-dashoffset 1.5s ease-in-out;
        }

        #login-circle-spinner.is-loading #login-progress-circle {
            stroke-dashoffset: 0;
        }
        
        /* Garante que a sidebar mobile cobre o conte√∫do */
        @media (max-width: 767px) {
            #sidebar.hidden {
                transform: translateX(-100%);
            }
            #sidebar {
                transition: transform 0.3s ease-in-out;
            }
        }
        
        /* Estilos de Pagina√ß√£o */
        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .pagination-btn.active {
            background-color: #003A70; /* enapor-blue */
            color: white;
        }
        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn:not(.active):not(.disabled):hover {
            background-color: #e5e7eb; /* gray-200 */
        }


    </style>
</head>

<body class="bg-enapor-gray text-gray-800">

    <!-- Ecr√£ de Login Modernizado --><div id="login-screen" class="flex items-center justify-center min-h-screen bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1577561824128-53c3c78f1082?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wzNzEyNjZ8MHwxfGFsbHx8fHx8fHx8fDE3Mjk5NzEwNjl8&ixlib=rb-4.0.3&q=80&w=1920');">
        <!-- Overlay escuro --><div class="absolute inset-0 bg-enapor-blue/80 backdrop-blur-sm"></div>
        
        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-xl space-y-6 z-10">
            
            <!-- Contenedor do √çcone e Spinner --><div class="relative w-24 h-24 mx-auto">
                <!-- O √çcone (SVG) - Fica sempre vis√≠vel --><div class="absolute inset-0 flex items-center justify-center">
                    <!-- √çcone para 'Descarga Digital': Um contentor com uma seta para baixo --><svg class="w-12 h-12 text-enapor-blue" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <path d="M12 15v-6m-3 3 3 3 3-3"/> <!-- Seta para baixo --></svg>
                </div>
                
                <!-- C√≠rculo de Anima√ß√£o SVG --><svg id="login-circle-spinner" class="w-full h-full" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- C√≠rculo de fundo (o trilho) --><circle class="text-enapor-blue/20" stroke-width="4" stroke="currentColor" fill="transparent" r="46" cx="50" cy="50"/>
                    
                    <!-- C√≠rculo de progresso (a linha que preenche) --><circle id="login-progress-circle" 
                            class="text-enapor-blue" 
                            stroke-width="4" 
                            stroke-linecap="round" 
                            stroke="currentColor" 
                            fill="transparent" 
                            r="46" 
                            cx="50" 
                            cy="50"
                            transform="rotate(-90 50 50)"/> <!-- Roda -90 graus para come√ßar do topo --></svg>
            </div>
            
            <!-- T√çTULO --><div class="text-center">
                <h1 class="text-3xl font-bold text-enapor-blue">Descarga Digital</h1>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-user" class="block text-sm font-medium text-gray-700">Utilizador</label>
                    <input type="text" id="login-user" name="user" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" required>
                </div>
                <div>
                    <label for="login-pass" class="block text-sm font-medium text-gray-700">Palavra-passe</label>
                    <input type="password" id="login-pass" name="pass" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" required>
                </div>
                
                <!-- Mensagem de Erro de Login --><div id="login-error" class="text-enapor-red text-sm text-center hidden pt-2">
                    Utilizador ou palavra-passe incorretos.
                </div>
                
                <button type="submit" class="w-full px-4 py-3 text-sm font-semibold text-white bg-enapor-blue rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-enapor-blue focus:ring-offset-2 transition-all">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Aplica√ß√£o principal agora tem um ID e est√° oculta (hidden) --><div id="dashboard-app" class="flex h-screen hidden">
        <!-- Barra Lateral (Sidebar) --><aside id="sidebar" class="w-64 bg-enapor-blue text-white p-6 shadow-lg hidden md:flex flex-col flex-shrink-0 absolute md:relative z-20 h-full">
            <!-- Logo --><div class="mb-10 text-center"> <!-- Adicionado text-center para centralizar o logo --><img src="https://www.enapor.cv/web/image/843" alt="Logo ENAPOR" class="h-21 mx-auto"> <!-- Ajustado h-16 para tamanho, e mx-auto para centralizar --></div>
            
            <!-- Navega√ß√£o Principal --><nav class="flex-1 space-y-2">
                <a href="#" id="nav-navios" class="flex items-center gap-3 px-4 py-3 bg-white/10 text-white font-semibold rounded-lg">
                    <!-- √çcone üö¢ (Lucide: ShipWheel) --><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4"/><path d="M2 12h4"/><path d="m19.07 4.93-.88.88"/><path d="m5.81 18.19.88-.88"/><path d="M12 2v4"/><path d="M12 22v-4"/><path d="m4.93 4.93.88.88"/><path d="m18.19 18.19-.88-.88"/><circle cx="12" cy="12" r="8"/><circle cx="12" cy="12" r="2"/></svg>
                    <span>Navios</span>
                </a>
                <a href="#" id="nav-descarga" class="flex items-center gap-3 px-4 py-3 text-gray-200 hover:bg-white/10 hover:text-white font-medium rounded-lg">
                    <!-- √çcone  (Lucide: Box) --><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.29 7 12 12 20.71 7"></polyline><line x1="12" x2="12" y1="22" y2="12"></line></svg>
                    <span>Descarga</span>
                </a>
            </nav>
            
            <!-- Logout --><div class="mt-auto">
                <a href="#" id="logout-btn" class="flex items-center gap-3 px-4 py-3 text-gray-200 hover:bg-white/10 hover:text-white font-medium rounded-lg">
                    <!-- √çcone üîí (Lucide: LogOut) --><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>
                    <span>Terminar sess√£o</span>
                </a>
            </div>
        </aside>

        <!-- Conte√∫do Principal --><div class="flex-1 flex flex-col overflow-hidden">
            
            <!-- Header (Cabe√ßalho) --><header class="bg-white h-20 flex-shrink-0 shadow-sm flex items-center justify-between px-4 md:px-8">
                <!-- Lado Esquerdo: Bot√£o Mobile e T√≠tulo --><div class="flex items-center gap-3">
                    <!-- Bot√£o Menu Mobile --><button id="mobile-menu-btn" aria-label="Abrir menu" class="md:hidden text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="3" x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="6" y2="6"></line><line x1="3" x2="21" y1="18" y2="18"></line></svg>
                    </button>
                    
                    <!-- T√≠tulo (Azul) - Tamanho responsivo --><h1 class="text-2xl md:text-3xl font-bold text-enapor-blue">Descarga Digital</h1>
                </div>

                <!-- Lado Direito: Perfil do Utilizador (Avatar vis√≠vel no mobile) --><div class="flex items-center gap-3">
                    <img class="w-8 h-8 md:w-10 md:h-10 rounded-full object-cover" src="https://placehold.co/100x100/003A70/FFFFFF?text=JS" alt="Avatar Jo√£o Silva">
                    <div class="text-sm hidden md:block"> <!-- Texto escondido no mobile -->
                        <p class="font-semibold text-gray-900">Jo√£o Silva</p>
                        <p class="text-gray-500">Operador</p>
                    </div>
                </div>
            </header>

            <!-- √Årea de Conte√∫do (com scroll) --><main class="flex-1 overflow-y-auto p-6 md:p-8 space-y-6">

                <!-- Tabela de Navios --><div id="navios-section" class="space-y-6">
                    <!-- NOVO: T√≠tulo e Barra de Pesquisa --><div class="space-y-4">
                        <!-- O T√≠tulo h1 foi movido para o <header> global -->
                        <div class="max-w-xl relative">
                            <label for="ship-search-input" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                                <!-- √çcone de Pesquisa (Lucide: Search) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>
                            </label>
                            <!-- Pesquisa de Navios --><input type="text" id="ship-search-input" placeholder="Procurar por navio ou escala..." class="w-full pl-11 pr-4 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-enapor-blue">
                        </div>
                    </div>
                        
                    <!-- KPIs da sec√ß√£o de Navios --><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-enapor-blue text-white p-6 rounded-2xl shadow-lg">
                            <p class="text-sm text-blue-100">Navios em Porto</p>
                            <p id="kpi-navios-porto" class="text-3xl font-bold text-white mt-1">0</p>
                        </div>
                        <div class="bg-enapor-green text-white p-6 rounded-2xl shadow-lg">
                            <p class="text-sm text-green-100">Navios Descarregados</p>
                            <p id="kpi-navios-descarregados" class="text-3xl font-bold text-white mt-1">0</p>
                        </div>
                        <div class="bg-enapor-orange text-white p-6 rounded-2xl shadow-lg">
                            <p class="text-sm text-orange-100">Navios em Descarga</p>
                            <p id="kpi-navios-descarga" class="text-3xl font-bold text-white mt-1">0</p>
                        </div>
                    </div>

                    <!-- Tabela de Navios --><div id="ship-table-container" class="bg-white rounded-2xl shadow-lg">
                        <!-- Cabe√ßalho da Tabela --><div class="px-6 py-5 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-900">Navios em Porto</h2>
                        </div>
                        
                        <!-- Wrapper da Tabela (para scroll horizontal) --><div class="overflow-x-auto">
                            <table class="w-full min-w-[600px] text-sm">
                                <thead>
                                    <tr class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <th class="px-6 py-4">Navio</th>
                                        <th class="px-6 py-4">Porto Anterior</th>
                                        <th class="px-6 py-4">N¬∫ da Escala</th>
                                        <th class="px-6 py-4">Atraca√ß√£o</th>
                                        <th class="px-6 py-4 text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="ship-table-body" class="">
                                    <!-- Conte√∫do gerado por JS --></tbody>
                            </table>
                        </div>
                        
                        <!-- Controlo de Pagina√ß√£o Navios --><div id="ship-pagination" class="px-6 py-4 border-t border-gray-200 flex justify-center items-center gap-2 text-sm">
                            <!-- Gerado por JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Sec√ß√£o de Descarga --><div id="descarga-section" class="hidden space-y-6">
                    <!-- NOVO: T√≠tulo e Barra de Pesquisa --><div class="space-y-4">
                        <!-- O T√≠tulo h1 foi movido para o <header> global -->
                        <div class="max-w-xl relative">
                            <label for="main-search-input" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                                <!-- √çcone de Pesquisa (Lucide: Search) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>
                            </label>
                            <!-- Pesquisa de Contentores (oculta por defeito) --><input type="text" id="main-search-input" placeholder="Procurar por contentor..." class="w-full pl-11 pr-4 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-enapor-blue">
                        </div>
                    </div>

                    <!-- Cabe√ßalho de informa√ß√µes do navio adicionado --><div id="descarga-header" class="hidden bg-white p-5 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">
                            Navio: <span id="descarga-navio-nome" class="text-enapor-blue"></span>
                        </h3>
                        <div class="flex flex-col md:flex-row md:gap-6 text-sm">
                            <p><strong>Escala:</strong> <span id="descarga-navio-escala" class="text-gray-700"></span></p>
                            <p><strong>Atraca√ß√£o:</strong> <span id="descarga-navio-atracacao" class="text-gray-700"></span></p>
                        </div>
                    </div>
                    
                    <!-- Cart√µes KPI (Key Performance Indicators) --><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-enapor-blue text-white p-6 rounded-2xl shadow-lg">
                            <p class="text-sm text-blue-100">Total Contentores</p>
                            <p id="kpi-contentores-total" class="text-3xl font-bold text-white mt-1">0</p>
                        </div>
                        <div class="bg-enapor-green text-white p-6 rounded-2xl shadow-lg">
                            <p class="text-sm text-green-100">Contentores Descarregados</p>
                            <p id="kpi-contentores-descarregados" class="text-3xl font-bold text-white mt-1">0</p>
                        </div>
                        <div class="bg-enapor-orange text-white p-6 rounded-2xl shadow-lg">
                            <p class="text-sm text-orange-100">Contentores por Descarregar</p>
                            <p id="kpi-contentores-pendentes" class="text-3xl font-bold text-white mt-1">0</p>
                        </div>
                    </div>

                    <!-- Tabela de Detalhes da Descarga --><div class="bg-white rounded-2xl shadow-lg">
                        <!-- Cabe√ßalho da Tabela e Filtros --><div class="px-6 py-5 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <h2 class="text-xl font-semibold text-gray-900">Descargas em curso</h2>
                            <!-- Filtros e Bot√£o de Registo Manual --><div class="flex flex-wrap items-center justify-start md:justify-end gap-3">
                                <div id="discharge-filters" class="flex items-center gap-2" role="group" aria-label="Filtros de descarga">
                                    <button data-filter="todos" class="px-4 py-1.5 text-sm rounded-lg font-semibold text-gray-900 bg-gray-200" aria-pressed="true">Todos</button>
                                    <button data-filter="descarregado" class="px-4 py-1.5 text-sm rounded-lg font-medium text-gray-500 hover:bg-gray-100" aria-pressed="false">Descarregados</button>
                                    <button data-filter="pendente" class="px-4 py-1.5 text-sm rounded-lg font-medium text-gray-500 hover:bg-gray-100" aria-pressed="false">Pendentes</button>
                                </div>
                                <button id="open-manual-modal-btn" class="flex items-center gap-2 bg-enapor-orange text-white text-sm font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-orange-600 transition-all">
                                    <!-- √çcone (Lucide: Plus) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>
                                    <span>Carga Mais</span>
                                </button>
                                <button id="finish-operation-btn" class="hidden flex items-center gap-2 bg-green-600 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-all">
                                    <!-- √çcone (Lucide: Check) --><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    <span>Finalizar Opera√ß√£o</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Wrapper da Tabela (para scroll horizontal) --><div class="overflow-x-auto">
                            <table class="w-full min-w-[500px] text-sm">
                                <thead>
                                    <tr class="text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <th class="px-6 py-4">Navio</th>
                                        <th class="px-6 py-4">N¬∫ da Escala</th>
                                        <th class="px-6 py-4">Contentor</th>
                                        <th class="px-6 py-4">Tipo</th>
                                        <th class="px-6 py-4">Data de descarga</th>
                                        <th class="px-6 py-4 text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="discharge-table-body" class="">
                                    <!-- Conte√∫do gerado por JS --></tbody>
                            </table>
                        </div>
                        
                        <!-- Controlo de Pagina√ß√£o Descarga --><div id="discharge-pagination" class="px-6 py-4 border-t border-gray-200 flex justify-center items-center gap-2 text-sm">
                            <!-- Gerado por JS -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Registo Manual --><div id="manual-register-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all opacity-0 scale-95">
            <!-- Cabe√ßalho do Modal --><div class="px-6 py-5 border-b border-gray-200">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Registar Carga Mais</h3>
            </div>
            
            <!-- Corpo do Modal com Formul√°rio --><form id="manual-register-form" class="p-6 space-y-4">
                <div>
                    <label for="manual-ship-select" class="block text-sm font-medium text-gray-700 mb-1">Navio</label>
                    <select id="manual-ship-select" name="ship" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" required>
                        <option value="">Selecione um navio...</option>
                        <!-- Op√ß√µes preenchidas por JS --></select>
                </div>
                <div>
                    <label for="manual-container-input" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Contentor</label>
                    <input type="text" id="manual-container-input" name="container" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" placeholder="Ex: MSCU1234567" required>
                </div>
                 <div>
                    <label for="manual-container-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</o>
                    <select id="manual-container-type" name="type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-enapor-blue" required>
                        <option value="20P">20P</option>
                        <option value="40P">40P</option>
                        <option value="10P">10P</option>
                    </select>
                </div>
                <!-- Mensagem de erro (substitui o alert) --><div id="manual-register-error" class="text-enapor-red text-sm hidden"></div>
            </form>
            
            <!-- Rodap√© do Modal com A√ß√µes --><div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                <button id="cancel-manual-modal-btn" type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancelar
                </button>
                <button id="save-manual-modal-btn" type="submit" form="manual-register-form" class="px-4 py-2 text-sm font-medium text-white bg-enapor-blue rounded-lg hover:bg-opacity-90">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification --><div id="toast-notification" class="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out z-50">
        <p id="toast-message">Mensagem de sucesso!</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Base de Dados (Simulada) ---
            let db = {
                ships: [
                    {
                        name: "MAR D¬¥CANAL",
                        port: "NLRTM, NL",
                        flag: "nl",
                        escala: "GRA2025002630",
                        ata: "2025-11-01T10:00:00",
                        status: "pending" // 'pending' ou 'finished'
                    },
                    {
                        name: "B.L√âZA",
                        port: "ESALG, ES",
                        flag: "es",
                        escala: "GRA2025002633",
                        ata: "2025-11-01T16:30:00",
                        status: "pending"
                    },
                    {
                        name: "CHIQUINHO BL",
                        port: "DEHAM, DE",
                        flag: "de",
                        escala: "GRA2025002640",
                        ata: "2025-11-02T09:00:00",
                        status: "pending"
                    },
                    {
                        name: "DONA TUTUTA",
                        port: "PTLXS, PT",
                        flag: "pt",
                        escala: "GRA2025002642",
                        ata: "2025-11-02T11:00:00",
                        status: "pending"
                    },
                    {
                        name: "PONTA DO SOL",
                        port: "FRMRS, FR",
                        flag: "fr",
                        escala: "GRA2025002650",
                        ata: "2025-11-02T14:00:00",
                        status: "pending"
                    },
                    {
                        name: "PRAIA D¬¥AGUADA",
                        port: "USNYC, US",
                        flag: "us",
                        escala: "GRA2025002651",
                        ata: "2025-11-02T18:00:00",
                        status: "pending"
                    },
                    {
                        name: "MONTE CARA",
                        port: "ITGOA, IT",
                        flag: "it",
                        escala: "GRA2025002655",
                        ata: "2025-11-03T08:00:00",
                        status: "pending"
                    },
                    {
                        name: "RIB. GRANDE",
                        port: "ESSVN, ES",
                        flag: "es",
                        escala: "GRA2025002656",
                        ata: "2025-11-03T10:30:00",
                        status: "pending"
                    },
                    {
                        name: "SANTO ANTAO",
                        port: "NLRTM, NL",
                        flag: "nl",
                        escala: "GRA2025002660",
                        ata: "2025-11-03T11:00:00",
                        status: "pending"
                    },
                    {
                        name: "MAR DE CANAL II",
                        port: "DEHAM, DE",
                        flag: "de",
                        escala: "GRA2025002661",
                        ata: "2025-11-03T12:45:00",
                        status: "pending"
                    }
                ],
                discharges: [
                    // MAR D¬¥CANAL
                    { id: 1, shipName: "MAR D¬¥CANAL", escala: "GRA2025002630", container: "MSCU1234567", type: "20P", status: "descarregado", dischargeTime: "2025-11-01T10:45:12" },
                    { id: 3, shipName: "MAR D¬¥CANAL", escala: "GRA2025002630", container: "MSCU1234568", type: "20P", status: "descarregado", dischargeTime: "2025-11-01T10:50:02" },
                    { id: 7, shipName: "MAR D¬¥CANAL", escala: "GRA2025002630", container: "TRLU6543210", type: "40P", status: "pendente", dischargeTime: null },
                    
                    // B.L√âZA
                    { id: 2, shipName: "B.L√âZA", escala: "GRA2025002633", container: "CMAU7654321", type: "40P", status: "pendente", dischargeTime: null },
                    { id: 8, shipName: "B.L√âZA", escala: "GRA2025002633", container: "CMAU7654322", type: "40P", status: "pendente", dischargeTime: null },
                    { id: 9, shipName: "B.L√âZA", escala: "GRA2025002633", container: "HLCU1112223", type: "20P", status: "descarregado", dischargeTime: "2025-11-01T17:00:00" },
                    
                    // CHIQUINHO BL
                    { id: 4, shipName: "CHIQUINHO BL", escala: "GRA2025002640", container: "MRSU8765432", type: "40P", status: "pendente", dischargeTime: null },
                    { id: 5, shipName: "CHIQUINHO BL", escala: "GRA2025002640", container: "MAEU5432109", type: "20P", status: "descarregado", dischargeTime: "2025-11-02T09:15:45" },
                    { id: 10, shipName: "CHIQUINHO BL", escala: "GRA2025002640", container: "MRSU8765433", type: "40P", status: "pendente", dischargeTime: null },
                    { id: 11, shipName: "CHIQUINHO BL", escala: "GRA2025002640", container: "MRSU8765434", type: "40P", status: "pendente", dischargeTime: null },
                    
                    // DONA TUTUTA
                    { id: 6, shipName: "DONA TUTUTA", escala: "GRA2025002642", container: "EASU4567890", type: "40P", status: "pendente", dischargeTime: null },
                    { id: 12, shipName: "DONA TUTUTA", escala: "GRA2025002642", container: "EASU4567891", type: "20P", status: "descarregado", dischargeTime: "2025-11-02T11:30:00" },
                    { id: 13, shipName: "DONA TUTUTA", escala: "GRA2025002642", container: "EASU4567892", type: "40P", status: "pendente", dischargeTime: null },
                    
                    // PONTA DO SOL
                    { id: 14, shipName: "PONTA DO SOL", escala: "GRA2025002650", container: "FCIU9876543", type: "20P", status: "pendente", dischargeTime: null },
                    
                    // PRAIA D¬¥AGUADA
                    { id: 15, shipName: "PRAIA D¬¥AGUADA", escala: "GRA2025002651", container: "OOLU1231234", type: "40P", status: "pendente", dischargeTime: null },
                    { id: 16, shipName: "PRAIA D¬¥AGUADA", escala: "GRA2025002651", container: "OOLU1231235", type: "20P", status: "pendente", dischargeTime: null },
                    
                    // MONTE CARA
                    { id: 17, shipName: "MONTE CARA", escala: "GRA2025002655", container: "TCNU5554443", type: "20P", status: "descarregado", dischargeTime: "2025-11-03T08:30:10" },
                    { id: 18, shipName: "MONTE CARA", escala: "GRA2025002655", container: "TCNU5554444", type: "40P", status: "pendente", dischargeTime: null },
                    
                    // RIB. GRANDE
                    { id: 19, shipName: "RIB. GRANDE", escala: "GRA2025002656", container: "ZCSU7778889", type: "40P", status: "pendente", dischargeTime: null },
                    { id: 20, shipName: "RIB. GRANDE", escala: "GRA2025002656", container: "ZCSU7778880", type: "40P", status: "pendente", dischargeTime: null },
                    
                    // SANTO ANTAO
                    { id: 21, shipName: "SANTO ANTAO", escala: "GRA2025002660", container: "MSCU9998887", type: "20P", status: "pendente", dischargeTime: null },
                    { id: 22, shipName: "SANTO ANTAO", escala: "GRA2025002660", container: "MSCU9998886", type: "20P", status: "pendente", dischargeTime: null },
                    { id: 23, shipName: "SANTO ANTAO", escala: "GRA2025002660", container: "MSCU9998885", type: "40P", status: "pendente", dischargeTime: null },
                    
                    // MAR DE CANAL II
                    { id: 24, shipName: "MAR DE CANAL II", escala: "GRA2025002661", container: "TRLU8887776", type: "40P", status: "pendente", dischargeTime: null }
                ]
            };
            
            // --- Estado da Aplica√ß√£o ---
            let state = {
                currentView: 'login', // 'login', 'navios', 'descarga'
                currentShipFilter: null, // null (todos) ou "Nome do Navio"
                currentStatusFilter: 'todos', // 'todos', 'pendente', 'descarregado'
                shipSearchTerm: '',
                dischargeSearchTerm: '',
                itemsPerPage: 7,
                shipsCurrentPage: 1,
                dischargeCurrentPage: 1
            };

            // --- Seletores de Elementos (DOM) ---
            // Login
            const loginScreen = document.getElementById('login-screen');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const loginPassInput = document.getElementById('login-pass');
            const loginCircleSpinner = document.getElementById('login-circle-spinner');
            const loginButton = loginForm.querySelector('button[type="submit"]');
            
            // App Principal
            const dashboardApp = document.getElementById('dashboard-app');
            const logoutBtn = document.getElementById('logout-btn');
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');

            // Navega√ß√£o
            const navNavios = document.getElementById('nav-navios');
            const navDescarga = document.getElementById('nav-descarga');
            
            // Sec√ß√µes
            const naviosSection = document.getElementById('navios-section');
            const descargaSection = document.getElementById('descarga-section');

            // Pesquisa
            const mainSearchInput = document.getElementById('main-search-input'); // Contentores
            const shipSearchInput = document.getElementById('ship-search-input'); // Navios

            // Tabelas
            const shipTableBody = document.getElementById('ship-table-body');
            const dischargeTableBody = document.getElementById('discharge-table-body');
            const shipPaginationContainer = document.getElementById('ship-pagination');
            const dischargePaginationContainer = document.getElementById('discharge-pagination');
            
            // Filtros Descarga
            const dischargeFilterButtons = document.querySelectorAll('#discharge-filters button');
            
            // Cabe√ßalho Descarga
            const descargaHeader = document.getElementById('descarga-header');
            const descargaNavioNome = document.getElementById('descarga-navio-nome');
            const descargaNavioEscala = document.getElementById('descarga-navio-escala');
            const descargaNavioAtracacao = document.getElementById('descarga-navio-atracacao');

            // Modal
            const manualModal = document.getElementById('manual-register-modal');
            const manualModalContent = manualModal.querySelector('.bg-white');
            const openModalBtn = document.getElementById('open-manual-modal-btn');
            const cancelModalBtn = document.getElementById('cancel-manual-modal-btn');
            const manualForm = document.getElementById('manual-register-form');
            const shipSelect = document.getElementById('manual-ship-select');
            const containerInput = document.getElementById('manual-container-input');
            const containerTypeSelect = document.getElementById('manual-container-type');
            const manualErrorDiv = document.getElementById('manual-register-error');
            const finishOperationBtn = document.getElementById('finish-operation-btn');

            // Toast
            const toastNotification = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            let toastTimer;

            // --- Fun√ß√µes de Renderiza√ß√£o ---

            /**
             * Mostra uma notifica√ß√£o toast.
             * @param {string} message - A mensagem a exibir.
             * @param {boolean} [isSuccess=true] - true para sucesso (verde), false para erro (vermelho).
             */
            function showToast(message, isSuccess = true) {
                if (toastTimer) clearTimeout(toastTimer);

                toastMessage.textContent = message;
                toastNotification.classList.toggle('bg-green-600', isSuccess);
                toastNotification.classList.toggle('bg-enapor-red', !isSuccess);
                
                toastNotification.classList.remove('translate-x-full');
                toastNotification.classList.add('translate-x-0');

                toastTimer = setTimeout(() => {
                    toastNotification.classList.add('translate-x-full');
                    toastNotification.classList.remove('translate-x-0');
                }, 3000); // Esconde depois de 3 segundos
            }


            /**
             * Formata data ISO (ex: 2024-07-20T10:00:00) para DD/MM/AAAA HH:MM
             * @param {string | null} isoString
             * @returns {string}
             */
            function formatDateTime(isoString) {
                if (!isoString) return '--:--:--';
                try {
                    const date = new Date(isoString);
                    // pt-PT usa DD/MM/AAAA
                    const options = { 
                        dateStyle: 'short', 
                        timeStyle: 'medium', 
                        hour12: false 
                    };
                    return date.toLocaleString('pt-PT', options).replace(',', ''); // Remove v√≠rgula
                } catch (e) {
                    console.error('Data inv√°lida:', isoString);
                    return '--:--:--';
                }
            }
            
            /**
             * Formata data ISO (ex: 2024-07-20T10:00:00) para DD/MM/AAAA HH:MM (sem segundos)
             * @param {string} isoString
             * @returns {string}
             */
            function formatAtaDateTime(isoString) {
                 if (!isoString) return '--:--:--';
                try {
                    const date = new Date(isoString);
                    const options = { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false 
                    };
                    return date.toLocaleString('pt-PT', options).replace(',', '');
                } catch (e) {
                    console.error('Data inv√°lida:', isoString);
                    return '--:--:--';
                }
            }
            
            /**
             * Renderiza a pagina√ß√£o.
             * @param {HTMLElement} container - O elemento que cont√©m os bot√µes.
             * @param {number} totalItems - Total de itens (para calcular p√°ginas).
             * @param {number} currentPage - A p√°gina atual.
             * @param {function(number):void} pageChangeCallback - Fun√ß√£o chamada ao clicar num bot√£o de p√°gina.
             */
            function renderPagination(container, totalItems, currentPage, pageChangeCallback) {
                container.innerHTML = ''; // Limpar
                const totalPages = Math.ceil(totalItems / state.itemsPerPage);

                if (totalPages <= 1) {
                    return; // N√£o mostrar pagina√ß√£o se houver 1 ou 0 p√°ginas
                }

                // Bot√£o "Anterior"
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '&laquo; Anterior';
                prevBtn.className = 'pagination-btn';
                if (currentPage === 1) {
                    prevBtn.classList.add('disabled');
                } else {
                    prevBtn.addEventListener('click', () => pageChangeCallback(currentPage - 1));
                }
                container.appendChild(prevBtn);

                // Bot√µes de P√°gina (simplificado: mostra a p√°gina atual)
                // Para uma l√≥gica mais complexa (ex: 1 ... 4 5 6 ... 10) seria preciso mais c√≥digo
                const pageInfo = document.createElement('span');
                pageInfo.className = "px-2 text-gray-700";
                pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
                container.appendChild(pageInfo);


                // Bot√£o "Seguinte"
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = 'Seguinte &raquo;';
                nextBtn.className = 'pagination-btn';
                if (currentPage === totalPages) {
                    nextBtn.classList.add('disabled');
                } else {
                    nextBtn.addEventListener('click', () => pageChangeCallback(currentPage + 1));
                }
                container.appendChild(nextBtn);
            }


            /**
             * Renderiza a tabela de navios com base nos dados e filtros.
             */
            function renderShipTable() {
                // Ordenar navios por data de atraca√ß√£o (ata)
                const sortedShips = [...db.ships].sort((a, b) => new Date(a.ata) - new Date(b.ata));
                
                // Filtrar por termo de pesquisa
                const filteredShips = sortedShips.filter(ship => {
                    const searchTerm = state.shipSearchTerm.toLowerCase();
                    const nameMatch = ship.name.toLowerCase().includes(searchTerm);
                    const escalaMatch = ship.escala.toLowerCase().includes(searchTerm);
                    return nameMatch || escalaMatch;
                });
                
                // Paginar
                const startIndex = (state.shipsCurrentPage - 1) * state.itemsPerPage;
                const endIndex = startIndex + state.itemsPerPage;
                const paginatedShips = filteredShips.slice(startIndex, endIndex);

                // Limpar tabela
                shipTableBody.innerHTML = '';

                if (filteredShips.length === 0) {
                     shipTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Nenhum navio encontrado.</td></tr>`;
                } else {
                    // Criar e adicionar linhas
                    paginatedShips.forEach(ship => {
                        const row = document.createElement('tr');
                        const isFinished = ship.status === 'finished';
                        row.className = `border-b border-gray-100 last:border-b-0 ${isFinished ? 'linha-descarregada' : 'hover:bg-gray-50'}`;
                        
                        const ataFormatted = formatAtaDateTime(ship.ata);
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${ship.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600 flex items-center gap-2">
                                ${ship.port} 
                                <img src="https://flagcdn.com/w20/${ship.flag}.png" alt="Bandeira ${ship.flag.toUpperCase()}" class="h-3">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">${ship.escala}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">${ataFormatted}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <button class="font-medium text-enapor-blue hover:underline view-containers-btn" data-ship-name="${ship.name}">
                                    Ver Contentores
                                </button>
                            </td>
                        `;
                        shipTableBody.appendChild(row);
                    });
                }
                
                // Renderizar Pagina√ß√£o
                renderPagination(shipPaginationContainer, filteredShips.length, state.shipsCurrentPage, (newPage) => {
                    state.shipsCurrentPage = newPage;
                    renderShipTable(); // Re-renderizar tabela com a nova p√°gina
                });
            }

            /**
             * Renderiza a tabela de descargas com base nos dados e filtros.
             */
            function renderDischargeTable() {
                // Filtrar descargas
                const filteredDischarges = db.discharges.filter(item => {
                    const shipMatch = !state.currentShipFilter || item.shipName === state.currentShipFilter;
                    const statusMatch = state.currentStatusFilter === 'todos' || item.status === state.currentStatusFilter;
                    const searchMatch = item.container.toLowerCase().includes(state.dischargeSearchTerm.toLowerCase());
                    return shipMatch && statusMatch && searchMatch;
                });
                
                // Paginar
                const startIndex = (state.dischargeCurrentPage - 1) * state.itemsPerPage;
                const endIndex = startIndex + state.itemsPerPage;
                const paginatedDischarges = filteredDischarges.slice(startIndex, endIndex);

                // Limpar tabela
                dischargeTableBody.innerHTML = '';

                if (filteredDischarges.length === 0) {
                     dischargeTableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhum contentor encontrado.</td></tr>`;
                } else {
                    // Criar e adicionar linhas
                    paginatedDischarges.forEach(item => {
                        const row = document.createElement('tr');
                        const isPendente = item.status === 'pendente';
                        row.className = `border-b border-gray-100 last:border-b-0 ${isPendente ? 'linha-pendente' : 'linha-descarregada'}`;
                        
                        const timeFormatted = formatDateTime(item.dischargeTime);
                        
                        const actionButtonHtml = isPendente
                            ? `<button class="px-3 py-1 text-xs font-medium text-white bg-enapor-blue rounded-md hover:bg-opacity-90 action-btn" data-action="descarregar" data-id="${item.id}">Descarregar</button>`
                            : `<button class="px-3 py-1 text-xs font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 action-btn" data-action="desmarcar" data-id="${item.id}">Desmarcar</button>`;
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${item.shipName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">${item.escala}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">${item.container}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">${item.type}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">${timeFormatted}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                ${actionButtonHtml}
                            </td>
                        `;
                        dischargeTableBody.appendChild(row);
                    });
                }
                
                // Renderizar Pagina√ß√£o
                renderPagination(dischargePaginationContainer, filteredDischarges.length, state.dischargeCurrentPage, (newPage) => {
                    state.dischargeCurrentPage = newPage;
                    renderDischargeTable(); // Re-renderizar tabela com a nova p√°gina
                });
            }

            // --- Fun√ß√µes de Atualiza√ß√£o de Estado e UI ---

            /**
             * Atualiza os KPIs da sec√ß√£o Navios.
             */
            function updateShipKPIs() {
                const totalShips = db.ships.length;
                const finishedShips = db.ships.filter(s => s.status === 'finished').length;
                
                document.getElementById('kpi-navios-porto').textContent = totalShips;
                document.getElementById('kpi-navios-descarregados').textContent = finishedShips; // KPI agora reflete navios finalizados
                document.getElementById('kpi-navios-descarga').textContent = totalShips; // "Navios em Descarga" = "Navios em Porto"
            }

            /**
             * Atualiza os KPIs da sec√ß√£o Descarga.
             */
            function updateDischargeKPIs() {
                // Filtra descargas com base APENAS no filtro de navio
                const relevantDischarges = db.discharges.filter(item => 
                    !state.currentShipFilter || item.shipName === state.currentShipFilter
                );

                const descarregadosCount = relevantDischarges.filter(item => item.status === 'descarregado').length;
                const pendentesCount = relevantDischarges.filter(item => item.status === 'pendente').length;
                
                document.getElementById('kpi-contentores-total').textContent = descarregadosCount + pendentesCount;
                document.getElementById('kpi-contentores-descarregados').textContent = descarregadosCount;
                document.getElementById('kpi-contentores-pendentes').textContent = pendentesCount;
            }

            /**
             * Mostra uma "view" (sec√ß√£o) principal e esconde as outras.
             * @param {string} viewName - O nome da view ('navios' ou 'descarga').
             * @param {object | null} [shipInfo=null] - (Opcional) Objeto com {name, escala, atracacao}.
             */
            function showView(viewName, shipInfo = null) {
                state.currentView = viewName;
                state.currentShipFilter = shipInfo ? shipInfo.name : null;

                // Esconder todas as sec√ß√µes
                naviosSection.classList.add('hidden');
                descargaSection.classList.add('hidden');
                descargaHeader.classList.add('hidden');
                finishOperationBtn.classList.add('hidden'); // Esconder bot√£o 'Finalizar' por defeito
                
                // REMOVIDO: Controlo de visibilidade das barras de pesquisa

                // Resetar estado ativo da navega√ß√£o
                [navNavios, navDescarga].forEach(nav => {
                    nav.classList.remove('bg-white/10', 'text-white', 'font-semibold');
                    nav.classList.add('text-gray-200', 'font-medium', 'hover:text-white');
                });

                if (viewName === 'navios') {
                    naviosSection.classList.remove('hidden');
                    state.dischargeSearchTerm = ''; // Limpa pesquisa de contentores
                    mainSearchInput.value = ''; 
                    state.shipsCurrentPage = 1; // Resetar p√°gina
                    
                    navNavios.classList.add('bg-white/10', 'text-white', 'font-semibold');
                    navNavios.classList.remove('text-gray-200', 'font-medium', 'hover:text-white');
                    
                    renderShipTable();
                    updateShipKPIs();
                
                } else if (viewName === 'descarga') {
                    descargaSection.classList.remove('hidden');
                    state.shipSearchTerm = ''; // Limpa pesquisa de navios
                    shipSearchInput.value = ''; 
                    state.dischargeCurrentPage = 1; // Resetar p√°gina
                    
                    navDescarga.classList.add('bg-white/10', 'text-white', 'font-semibold');
                    navDescarga.classList.remove('text-gray-200', 'font-medium', 'hover:text-white');
                    
                    // Se viemos de "Ver Contentores", preencher o cabe√ßalho
                    if (shipInfo) {
                        descargaNavioNome.textContent = shipInfo.name;
                        descargaNavioEscala.textContent = shipInfo.escala;
                        descargaNavioAtracacao.textContent = formatAtaDateTime(shipInfo.ata);
                        descargaHeader.classList.remove('hidden');
                        
                        // Mostrar bot√£o 'Finalizar' apenas se o navio n√£o estiver finalizado
                        const ship = db.ships.find(s => s.name === shipInfo.name);
                        if (ship && ship.status !== 'finished') {
                            finishOperationBtn.classList.remove('hidden');
                        }
                        
                        // Ao ver um navio espec√≠fico, mostrar 'todos' por defeito
                        state.currentStatusFilter = 'todos';
                    } else {
                        // Ao clicar em "Descarga", mostrar 'pendente' por defeito
                        state.currentStatusFilter = 'pendente';
                    }
                    
                    updateDischargeFilterUI();
                    renderDischargeTable();
                    updateDischargeKPIs();
                }
                
                // Fecha a sidebar no mobile ao navegar
                sidebar.classList.add('hidden');
                sidebar.classList.remove('flex'); // Garante que no mobile 'hidden' tem preced√™ncia
            }
            
            /**
             * Atualiza o estado visual dos bot√µes de filtro de descarga.
             */
            function updateDischargeFilterUI() {
                dischargeFilterButtons.forEach(btn => {
                    const isPressed = btn.dataset.filter === state.currentStatusFilter;
                    btn.classList.toggle('font-semibold', isPressed);
                    btn.classList.toggle('text-gray-900', isPressed);
                    btn.classList.toggle('bg-gray-200', isPressed);
                    
                    btn.classList.toggle('font-medium', !isPressed);
                    btn.classList.toggle('text-gray-500', !isPressed);
                    btn.classList.toggle('hover:bg-gray-100', !isPressed);
                    
                    btn.setAttribute('aria-pressed', isPressed);
                });
            }

            // --- L√≥gica do Modal ---

            function openManualModal() {
                // Preencher select com navios da DB
                shipSelect.innerHTML = '<option value="">Selecione um navio...</option>';
                
                // Mostrar apenas navios pendentes no modal
                db.ships.filter(s => s.status === 'pending').forEach(ship => {
                    const option = document.createElement('option');
                    option.value = ship.name;
                    option.textContent = ship.name;
                    // Guardar dados extra no option para f√°cil acesso
                    option.dataset.escala = ship.escala;
                    shipSelect.appendChild(option);
                });
                
                manualErrorDiv.classList.add('hidden'); // Limpar erros
                manualErrorDiv.textContent = '';
                manualForm.reset();

                // Mostrar modal com anima√ß√£o
                manualModal.classList.remove('hidden');
                setTimeout(() => {
                    manualModalContent.classList.remove('opacity-0', 'scale-95');
                    manualModalContent.classList.add('opacity-100', 'scale-100');
                }, 10);
            }

            function closeManualModal() {
                manualModalContent.classList.remove('opacity-100', 'scale-100');
                manualModalContent.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    manualModal.classList.add('hidden');
                }, 300); // Dura√ß√£o da anima√ß√£o
            }

            function handleManualFormSubmit(e) {
                e.preventDefault();
                manualErrorDiv.classList.add('hidden');
                
                const selectedShipName = shipSelect.value;
                const container = containerInput.value.toUpperCase();
                const type = containerTypeSelect.value;

                // Valida√ß√£o
                if (!selectedShipName) {
                    manualErrorDiv.textContent = 'Por favor, selecione um navio.';
                    manualErrorDiv.classList.remove('hidden');
                    return;
                }
                
                if (!container) { // Alterado: Apenas verifica se est√° vazio
                     manualErrorDiv.textContent = 'Por favor, insira um n√∫mero de contentor.';
                    manualErrorDiv.classList.remove('hidden');
                    return;
                }

                // Obter a escala do navio selecionado
                const selectedOption = shipSelect.querySelector(`option[value="${selectedShipName}"]`);
                const escala = selectedOption.dataset.escala;

                // Criar novo registo de descarga
                const newDischarge = {
                    id: Date.now(), // ID √∫nico
                    shipName: selectedShipName,
                    escala: escala,
                    container: container,
                    type: type,
                    status: "pendente", // "Carga Mais" entra como pendente
                    dischargeTime: null
                };

                // Adicionar √† base de dados simulada
                db.discharges.push(newDischarge);

                // Re-renderizar UI
                renderDischargeTable();
                updateDischargeKPIs();

                closeManualModal();
            }

            // --- L√≥gica de A√ß√µes da Tabela ---

            function handleDischargeAction(e) {
                const button = e.target.closest('.action-btn');
                if (!button) return;

                const action = button.dataset.action;
                const id = parseInt(button.dataset.id, 10);

                // Encontrar o item na "base de dados"
                const item = db.discharges.find(d => d.id === id);
                if (!item) return;

                if (action === 'descarregar') {
                    item.status = 'descarregado';
                    item.dischargeTime = new Date().toISOString();
                    // Mostrar Toast de sucesso
                    showToast(`Contentor ${item.container} descarregado com sucesso`);
                } else if (action === 'desmarcar') {
                    item.status = 'pendente';
                    item.dischargeTime = null;
                }

                // Re-renderizar a tabela e KPIs
                renderDischargeTable();
                updateDischargeKPIs();
            }
            
            function handleViewContainers(e) {
                 const button = e.target.closest('.view-containers-btn');
                 if (!button) return;
                 
                 e.preventDefault();
                 const shipName = button.dataset.shipName;
                 const ship = db.ships.find(s => s.name === shipName);
                 
                 if (ship) {
                    const shipInfo = {
                        name: ship.name,
                        escala: ship.escala,
                        ata: ship.ata // Passa a data ISO
                    };
                    showView('descarga', shipInfo);
                 }
            }

            /**
             * Finaliza a opera√ß√£o para o navio atual.
             */
            function handleFinishOperation() {
                if (!state.currentShipFilter) return; 

                const shipName = state.currentShipFilter;
                const ship = db.ships.find(s => s.name === shipName);
                
                if (ship) {
                    ship.status = 'finished'; // Marcar como finalizado
                    
                    // 1. Mostrar toast
                    showToast('Opera√ß√£o Finalizada com sucesso');
                    
                    // 2. Voltar para a sec√ß√£o de navios (que agora mostrar√° a linha a verde)
                    showView('navios');
                    
                    // 3. Atualizar KPIs dos Navios
                    updateShipKPIs();
                }
            }


            // --- Event Listeners ---

            // Login / Logout
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const user = e.target.elements.user.value;
                const pass = e.target.elements.pass.value;

                loginError.classList.add('hidden');
                loginCircleSpinner.classList.add('is-loading');
                loginButton.disabled = true;
                loginButton.classList.add('opacity-50');

                setTimeout(() => {
                    loginCircleSpinner.classList.remove('is-loading');
                    loginButton.disabled = false;
                    loginButton.classList.remove('opacity-50');

                    if (user === 'admin' && pass === 'admin') {
                        loginScreen.classList.add('hidden');
                        dashboardApp.classList.remove('hidden');
                        loginPassInput.value = '';
                        showView('navios'); // Mostrar 'navios' ao fazer login
                    } else {
                        loginError.textContent = 'Utilizador ou palavra-passe incorretos.';
                        loginError.classList.remove('hidden');
                    }
                }, 1500);
            });

            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                dashboardApp.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                loginPassInput.value = '';
                state.currentView = 'login';
            });
            
            // Menu Mobile
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('hidden'); // Alterna entre hidden e a classe de display (flex)
            });

            // Navega√ß√£o Principal
            navNavios.addEventListener('click', (e) => {
                e.preventDefault();
                showView('navios');
            });

            navDescarga.addEventListener('click', (e) => {
                e.preventDefault();
                showView('descarga'); // Mostra todos os contentores, filtrados por 'pendente'
            });

            // Pesquisa
            shipSearchInput.addEventListener('input', (e) => {
                state.shipSearchTerm = e.target.value;
                state.shipsCurrentPage = 1; // Resetar p√°gina ao pesquisar
                renderShipTable();
            });
            
            mainSearchInput.addEventListener('input', (e) => {
                state.dischargeSearchTerm = e.target.value;
                state.dischargeCurrentPage = 1; // Resetar p√°gina ao pesquisar
                renderDischargeTable();
            });
            
            // Filtros de Descarga
            document.getElementById('discharge-filters').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-filter]');
                if (!button) return;
                
                state.currentStatusFilter = button.dataset.filter;
                state.dischargeCurrentPage = 1; // Resetar p√°gina ao filtrar
                updateDischargeFilterUI();
                renderDischargeTable();
            });

            // A√ß√µes nas Tabelas (Event Delegation)
            shipTableBody.addEventListener('click', handleViewContainers);
            dischargeTableBody.addEventListener('click', handleDischargeAction);

            // Modal
            openModalBtn.addEventListener('click', openManualModal);
            cancelModalBtn.addEventListener('click', closeManualModal);
            manualModal.addEventListener('click', (e) => {
                if (e.target === manualModal) { // Fechar se clicar no fundo
                    closeManualModal();
                }
            });
            manualForm.addEventListener('submit', handleManualFormSubmit);

            // Bot√£o Finalizar Opera√ß√£o
            finishOperationBtn.addEventListener('click', handleFinishOperation);

            // --- Estado Inicial ---
            // A app agora espera pelo login para mostrar a primeira view.
        });
    </script>
</body>
</html>

